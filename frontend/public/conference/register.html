<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Register for ICSR 2026 - The International Conference on Shellfish Restoration in Puget Sound, Washington. Join 350+ restoration practitioners from 25+ countries.">
  <title>Conference Registration - ISRS 2026</title>

  <!-- Canonical URL -->
  <link rel="canonical" href="https://www.shellfish-society.org/conference/register.html">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://www.shellfish-society.org/conference/register.html">
  <meta property="og:title" content="Register for ICSR 2026 - International Shellfish Restoration Society">
  <meta property="og:description" content="Register for ICSR 2026 in Puget Sound, Washington. Join 350+ restoration practitioners from 25+ countries for cutting-edge research and workshops.">
  <meta property="og:image" content="https://www.shellfish-society.org/images/hero-shellfish.jpg">
  <meta property="og:site_name" content="International Shellfish Restoration Society">


  <link rel="icon" type="image/png" href="/images/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Marcellus&family=PT+Serif:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css?v=2.0">
  <script src="/js/analytics.js?v=2.0"></script>
  <!-- Google reCAPTCHA Enterprise -->
  <script src="https://www.google.com/recaptcha/enterprise.js?render=6LfnNQAsAAAAALsKryyU06I6fPvdQ_-7YgHAvYeA" async defer></script>
  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    body {
      background: var(--light-gray);
    }

    .registration-container {
      max-width: 900px;
      margin: 3rem auto;
      padding: 0 2rem;
    }

    .registration-header {
      background: var(--white);
      padding: 2rem;
      border-radius: 8px 8px 0 0;
      border-bottom: 3px solid var(--primary-blue);
      position: relative;
    }

    .back-button {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.25rem;
      background: var(--white);
      border: 2px solid var(--primary-blue);
      color: var(--primary-blue);
      text-decoration: none;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      cursor: pointer;
      margin-bottom: 1.5rem;
    }

    .back-button:hover {
      background: var(--primary-blue);
      color: var(--white);
      transform: translateX(-3px);
    }

    .back-button svg {
      width: 20px;
      height: 20px;
    }

    .registration-header h1 {
      font-family: 'Marcellus', Georgia, serif;
      color: var(--primary-blue);
      margin-bottom: 0.5rem;
      font-size: 2.5rem;
    }

    .registration-header p {
      color: var(--text-light);
      font-size: 1.1rem;
    }

    .progress-bar {
      background: var(--white);
      padding: 1.5rem 2rem;
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid var(--border-color);
    }

    .progress-step {
      flex: 1;
      text-align: center;
      position: relative;
      padding: 0 1rem;
    }

    .progress-step::after {
      content: '';
      position: absolute;
      top: 20px;
      left: 50%;
      width: 100%;
      height: 2px;
      background: var(--border-color);
      z-index: 0;
    }

    .progress-step:last-child::after {
      display: none;
    }

    .step-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--light-gray);
      color: var(--text-light);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      margin-bottom: 0.5rem;
      position: relative;
      z-index: 1;
    }

    .progress-step.active .step-number {
      background: var(--primary-blue);
      color: white;
    }

    .progress-step.completed .step-number {
      background: var(--accent-teal);
      color: white;
    }

    .step-label {
      font-size: 0.875rem;
      color: var(--text-light);
    }

    .progress-step.active .step-label {
      color: var(--primary-blue);
      font-weight: 600;
    }

    .registration-form {
      background: var(--white);
      padding: 3rem 2rem;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .form-section {
      display: none;
    }

    .form-section.active {
      display: block;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .section-title {
      font-family: 'Marcellus', Georgia, serif;
      color: var(--primary-blue);
      font-size: 1.75rem;
      margin-bottom: 1.5rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--accent-teal);
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--text-dark);
    }

    .form-group label .required {
      color: #dc3545;
      margin-left: 0.25rem;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-family: inherit;
      font-size: 1rem;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(46, 90, 138, 0.1);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .form-group small {
      display: block;
      margin-top: 0.25rem;
      color: var(--text-light);
      font-size: 0.875rem;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .checkbox-group {
      margin-top: 0.5rem;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .checkbox-item input[type="checkbox"] {
      width: auto;
      margin-right: 0.5rem;
    }

    .checkbox-item label {
      margin: 0;
      font-weight: normal;
    }

    .form-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 3rem;
      padding-top: 2rem;
      border-top: 1px solid var(--border-color);
    }

    .btn {
      padding: 0.875rem 2rem;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--primary-blue);
      color: white;
    }

    .btn-primary:hover {
      background: var(--secondary-blue);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(46, 90, 138, 0.2);
    }

    .btn-secondary {
      background: var(--light-gray);
      color: var(--text-dark);
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .fee-summary {
      background: var(--light-gray);
      padding: 1.5rem;
      border-radius: 4px;
      border-left: 4px solid var(--accent-teal);
    }

    .fee-summary h3 {
      font-family: 'Marcellus', Georgia, serif;
      color: var(--primary-blue);
      margin-bottom: 1rem;
    }

    .fee-item {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border-color);
    }

    .fee-item:last-child {
      border-bottom: none;
      font-weight: 700;
      font-size: 1.25rem;
      color: var(--primary-blue);
      padding-top: 1rem;
    }

    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }

    .loading-overlay.active {
      display: flex;
    }

    .loading-content {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      text-align: center;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--light-gray);
      border-top-color: var(--primary-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
      display: none;
    }

    .error-message.active {
      display: block;
    }

    .success-message {
      background: #d4edda;
      color: #155724;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
      display: none;
    }

    .success-message.active {
      display: block;
    }

    .toggle-button {
      padding: 0.75rem 1.5rem;
      border: 2px solid var(--border-color);
      background: white;
      color: var(--text-dark);
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      white-space: nowrap;
    }

    .toggle-button:hover {
      border-color: var(--primary-blue);
      background: rgba(46, 90, 138, 0.05);
    }

    .toggle-button.active {
      border-color: var(--primary-blue);
      background: var(--primary-blue);
      color: white;
    }

    .session-card {
      border: 2px solid var(--border-color);
      border-radius: 6px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      background: white;
    }

    .session-card:hover {
      border-color: var(--primary-blue);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transform: translateY(-1px);
    }

    .session-card.selected {
      border-color: var(--primary-blue);
      background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
      box-shadow: 0 3px 10px rgba(46, 90, 138, 0.15);
    }

    .session-card.full {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .session-card.full:hover {
      transform: none;
      box-shadow: none;
    }

    .session-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 0.75rem;
      gap: 1rem;
    }

    .session-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--primary-blue);
      margin-bottom: 0.25rem;
    }

    .session-meta {
      color: var(--text-light);
      font-size: 0.9rem;
    }

    .session-badges {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      align-items: flex-end;
    }

    .session-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .session-badge.workshop {
      background: #e3f2fd;
      color: #1976d2;
    }

    .session-badge.field-trip {
      background: #f3e5f5;
      color: #7b1fa2;
    }

    .session-badge.presentation {
      background: #e8f5e9;
      color: #388e3c;
    }

    .session-badge.available {
      background: #e8f5e9;
      color: #388e3c;
    }

    .session-badge.limited {
      background: #fff3e0;
      color: #f57c00;
    }

    .session-badge.waitlist {
      background: #ffebee;
      color: #d32f2f;
    }

    .session-description {
      color: var(--text-dark);
      margin-bottom: 0.5rem;
      line-height: 1.5;
    }

    .session-chair {
      font-size: 0.9rem;
      color: var(--text-light);
      margin-bottom: 0.5rem;
    }

    .session-fee-notice {
      margin-top: 0.75rem;
      padding: 0.75rem;
      background: #fff3e0;
      border-radius: 4px;
      font-size: 0.9rem;
      border-left: 3px solid #f57c00;
    }

    .sessions-by-date {
      margin-bottom: 2rem;
    }

    .session-date-header {
      color: var(--primary-blue);
      font-family: 'Marcellus', Georgia, serif;
      font-size: 1.4rem;
      margin: 2rem 0 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--accent-teal);
    }

    .session-date-header:first-child {
      margin-top: 0;
    }

    .no-sessions-message {
      text-align: center;
      padding: 3rem 2rem;
      color: var(--text-light);
      font-size: 1.1rem;
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }

      .progress-bar {
        flex-direction: column;
      }

      .progress-step::after {
        display: none;
      }

      .registration-header h1 {
        font-size: 2rem;
      }

      .session-header {
        flex-direction: column;
        align-items: start;
      }

      .session-badges {
        flex-direction: row;
        align-items: center;
        margin-top: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <header id="site-header"></header>

  <main id="main-content">
  <div class="registration-container">
    <div class="registration-header">
      <a href="/conference/" class="back-button" id="backButton">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        <span data-i18n="confRegBackToConf">Back to Conference Info</span>
      </a>
      <h1 data-i18n="confRegHeading">ISRS Conference 2026</h1>
      <p data-i18n="confRegSubtitle">Register for the International Shellfish Restoration Society Conference</p>
      <p><strong data-i18n="confRegDate">June 15-18, 2026</strong></p>
    </div>

    <div class="progress-bar">
      <div class="progress-step active" data-step="1">
        <div class="step-number">1</div>
        <div class="step-label" data-i18n="confRegStep1">Your Profile</div>
      </div>
      <div class="progress-step" data-step="2">
        <div class="step-number">2</div>
        <div class="step-label" data-i18n="confRegStep2">Registration Details</div>
      </div>
      <div class="progress-step" data-step="3">
        <div class="step-number">3</div>
        <div class="step-label" data-i18n="confRegStep3">Sessions & Workshops</div>
      </div>
      <div class="progress-step" data-step="4">
        <div class="step-number">4</div>
        <div class="step-label" data-i18n="confRegStep4">Review & Payment</div>
      </div>
    </div>

    <div class="registration-form">
      <div class="error-message" id="errorMessage"></div>
      <div class="success-message" id="successMessage"></div>

      <!-- Step 1: Profile -->
      <div class="form-section active" data-step="1">
        <h2 class="section-title" id="profileTitle" data-i18n="confRegStep1">Your Profile</h2>

        <div class="form-row">
          <div class="form-group">
            <label><span data-i18n="confRegFirstName">First Name</span> <span class="required">*</span></label>
            <input type="text" id="firstName" required>
          </div>
          <div class="form-group">
            <label><span data-i18n="confRegLastName">Last Name</span> <span class="required">*</span></label>
            <input type="text" id="lastName" required>
          </div>
        </div>

        <div class="form-group">
          <label><span data-i18n="confRegEmail">Email Address</span> <span class="required">*</span></label>
          <input type="email" id="email" required>
          <small data-i18n="confRegEmailHint">This will be your login email for accessing your registration</small>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label data-i18n="confRegOrganization">Organization</label>
            <input type="text" id="organizationName">
          </div>
          <div class="form-group">
            <label data-i18n="confRegPosition">Position/Title</label>
            <input type="text" id="position">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label><span data-i18n="confRegCountry">Country</span> <span class="required">*</span></label>
            <select id="country" required onchange="toggleStateField()">
              <option value="" data-i18n="confRegSelectCountry">Select country...</option>
              <option value="United States">United States</option>
              <option value="Canada">Canada</option>
              <option value="Mexico">Mexico</option>
              <option value="---" disabled>---</option>
              <option value="Afghanistan">Afghanistan</option>
              <option value="Albania">Albania</option>
              <option value="Algeria">Algeria</option>
              <option value="Argentina">Argentina</option>
              <option value="Australia">Australia</option>
              <option value="Austria">Austria</option>
              <option value="Bangladesh">Bangladesh</option>
              <option value="Belgium">Belgium</option>
              <option value="Brazil">Brazil</option>
              <option value="Bulgaria">Bulgaria</option>
              <option value="Chile">Chile</option>
              <option value="China">China</option>
              <option value="Colombia">Colombia</option>
              <option value="Costa Rica">Costa Rica</option>
              <option value="Croatia">Croatia</option>
              <option value="Cyprus">Cyprus</option>
              <option value="Czech Republic">Czech Republic</option>
              <option value="Denmark">Denmark</option>
              <option value="Ecuador">Ecuador</option>
              <option value="Egypt">Egypt</option>
              <option value="Estonia">Estonia</option>
              <option value="Finland">Finland</option>
              <option value="France">France</option>
              <option value="Germany">Germany</option>
              <option value="Greece">Greece</option>
              <option value="Hong Kong">Hong Kong</option>
              <option value="Hungary">Hungary</option>
              <option value="Iceland">Iceland</option>
              <option value="India">India</option>
              <option value="Indonesia">Indonesia</option>
              <option value="Ireland">Ireland</option>
              <option value="Israel">Israel</option>
              <option value="Italy">Italy</option>
              <option value="Japan">Japan</option>
              <option value="Kenya">Kenya</option>
              <option value="South Korea">South Korea</option>
              <option value="Latvia">Latvia</option>
              <option value="Lithuania">Lithuania</option>
              <option value="Luxembourg">Luxembourg</option>
              <option value="Malaysia">Malaysia</option>
              <option value="Malta">Malta</option>
              <option value="Morocco">Morocco</option>
              <option value="Netherlands">Netherlands</option>
              <option value="New Zealand">New Zealand</option>
              <option value="Nigeria">Nigeria</option>
              <option value="Norway">Norway</option>
              <option value="Pakistan">Pakistan</option>
              <option value="Peru">Peru</option>
              <option value="Philippines">Philippines</option>
              <option value="Poland">Poland</option>
              <option value="Portugal">Portugal</option>
              <option value="Romania">Romania</option>
              <option value="Russia">Russia</option>
              <option value="Saudi Arabia">Saudi Arabia</option>
              <option value="Singapore">Singapore</option>
              <option value="Slovakia">Slovakia</option>
              <option value="Slovenia">Slovenia</option>
              <option value="South Africa">South Africa</option>
              <option value="Spain">Spain</option>
              <option value="Sweden">Sweden</option>
              <option value="Switzerland">Switzerland</option>
              <option value="Taiwan">Taiwan</option>
              <option value="Thailand">Thailand</option>
              <option value="Turkey">Turkey</option>
              <option value="Ukraine">Ukraine</option>
              <option value="United Arab Emirates">United Arab Emirates</option>
              <option value="United Kingdom">United Kingdom</option>
              <option value="Vietnam">Vietnam</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group" id="stateFieldGroup" style="display: none;">
            <label id="stateLabel"><span data-i18n="confRegState">State</span> <span class="required">*</span></label>
            <select id="state"></select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label data-i18n="confRegCity">City</label>
            <input type="text" id="city">
          </div>
          <div class="form-group">
            <label data-i18n="confRegPhone">Phone Number</label>
            <input type="tel" id="phone">
          </div>
        </div>

        <div class="form-group">
          <label data-i18n="confRegBio">Professional Bio</label>
          <textarea id="bio" rows="4" data-i18n-placeholder="confRegBioPlaceholder" placeholder="Tell us about your work in shellfish restoration..."></textarea>
          <small data-i18n="confRegBioHint">This will be visible in the attendee directory</small>
        </div>

        <div class="form-group">
          <label data-i18n="confRegCV">CV/Resume Upload (Optional)</label>
          <input type="file" id="cvFile" accept=".pdf,.doc,.docx" style="padding: 0.5rem;">
          <small data-i18n="confRegCVLink">Or provide a link:</small>
          <input type="url" id="cvUrl" placeholder="https://..." style="margin-top: 0.5rem;">
        </div>

        <div class="form-group">
          <label data-i18n="confRegResearchAreas">Research Areas (comma-separated)</label>
          <input type="text" id="researchAreas" data-i18n-placeholder="confRegResearchPlaceholder" placeholder="e.g., oyster restoration, water quality, climate adaptation">
        </div>

        <div class="form-actions">
          <div></div>
          <button type="button" class="btn btn-primary" onclick="nextStep()" data-i18n="confRegNext">Next</button>
        </div>
      </div>

      <!-- Step 2: Registration Details -->
      <div class="form-section" data-step="2">
        <h2 class="section-title" data-i18n="confRegStep2">Registration Details</h2>

        <div class="form-group">
          <label><span data-i18n="confRegType">Registration Type</span> <span class="required">*</span></label>
          <select id="registrationType" onchange="updateFee()">
            <option value="" data-i18n="confRegSelectType">Select registration type...</option>
            <option value="early_bird"><span data-i18n="confRegEarlyBird">Early Bird</span> ($350)</option>
            <option value="student"><span data-i18n="confRegStudent">Student</span> ($250)</option>
          </select>
          <small style="color: var(--text-light); margin-top: 0.5rem; display: block;" data-i18n="confRegEarlyBirdNotice">
            üéâ Early Bird pricing available now! Register before March 1, 2026 to save.
          </small>
        </div>

        <!-- Discount Code Section -->
        <div class="form-group" style="margin-top: 1.5rem; padding: 1.5rem; background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%); border-radius: 6px; border: 2px solid #d0e8ff;">
          <label style="font-weight: 600; color: var(--primary-blue); display: flex; align-items: center; gap: 0.5rem;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"></path>
              <line x1="7" y1="7" x2="7.01" y2="7"></line>
            </svg>
            <span data-i18n="confRegDiscountCode">Discount Code (Optional)</span>
          </label>
          <small style="display: block; margin-top: 0.25rem; margin-bottom: 0.75rem; color: var(--text-light);" data-i18n="confRegDiscountHint">
            Have a promo code? Enter it here to save on your registration!
          </small>
          <div style="display: flex; gap: 0.5rem;">
            <input
              type="text"
              id="discountCode"
              data-i18n-placeholder="confRegDiscountPlaceholder"
              placeholder="Enter promo code (e.g., EARLYBIRD2026)"
              style="flex: 1; text-transform: uppercase;"
              oninput="this.value = this.value.toUpperCase()"
            >
            <button
              type="button"
              class="btn btn-secondary"
              onclick="validateDiscountCode()"
              id="applyDiscountBtn"
              style="padding: 0.875rem 1.5rem; white-space: nowrap;"
              data-i18n="confRegApplyCode"
            >
              Apply Code
            </button>
          </div>
          <div id="discountError" style="display: none; margin-top: 0.75rem; padding: 0.75rem; background: #fee; border: 1px solid #fcc; border-radius: 4px; color: #c00;">
          </div>
          <div id="discountSuccess" style="display: none; margin-top: 0.75rem; padding: 0.75rem; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; color: #155724;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
              <div style="flex: 1;">
                <strong id="discountDescription" style="display: flex; align-items: center; gap: 0.5rem;">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                  <span></span>
                </strong>
                <div id="discountAmount" style="font-size: 0.95rem; margin-top: 0.25rem;"></div>
              </div>
              <button
                type="button"
                onclick="removeDiscount()"
                style="background: none; border: none; color: #155724; cursor: pointer; padding: 0.25rem; font-size: 1.2rem; line-height: 1;"
                title="Remove discount code"
              >
                √ó
              </button>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label><span data-i18n="confRegAttendanceType">Attendance Type</span> <span class="required">*</span></label>
          <select id="attendanceType">
            <option value="in-person" data-i18n="confRegInPerson">In-Person</option>
            <option value="virtual" data-i18n="confRegVirtual">Virtual</option>
          </select>
        </div>

        <div class="checkbox-group">
          <div class="checkbox-item">
            <input type="checkbox" id="isFirstTime">
            <label for="isFirstTime" data-i18n="confRegFirstTime">This is my first ISRS conference</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="isPresenter">
            <label for="isPresenter" data-i18n="confRegPresenter">I plan to submit an abstract for presentation</label>
          </div>
        </div>

        <div class="form-group">
          <label data-i18n="confRegDietary">Dietary Restrictions</label>
          <select id="dietaryRestrictions">
            <option value="" data-i18n="confRegDietaryNone">None</option>
            <option value="vegetarian" data-i18n="confRegVegetarian">Vegetarian</option>
            <option value="vegan" data-i18n="confRegVegan">Vegan</option>
            <option value="gluten-free" data-i18n="confRegGlutenFree">Gluten-Free</option>
            <option value="other" data-i18n="confRegDietaryOther">Other (specify below)</option>
          </select>
        </div>

        <div class="form-group">
          <label data-i18n="confRegDietaryNotes">Dietary Notes</label>
          <textarea id="dietaryNotes" rows="2" data-i18n-placeholder="confRegDietaryPlaceholder" placeholder="Please specify any allergies or dietary requirements..."></textarea>
        </div>

        <div class="form-group">
          <label data-i18n="confRegAccessibility">Accessibility Needs</label>
          <textarea id="accessibilityNeeds" rows="2" data-i18n-placeholder="confRegAccessibilityPlaceholder" placeholder="Please let us know if you require any accommodations..."></textarea>
        </div>

        <div class="form-group">
          <label><span data-i18n="confRegEmergencyName">Emergency Contact Name</span> <span class="required">*</span></label>
          <input type="text" id="emergencyName" required>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label><span data-i18n="confRegEmergencyEmail">Emergency Contact Email</span> <span class="required">*</span></label>
            <input type="email" id="emergencyEmail" required>
          </div>
          <div class="form-group">
            <label><span data-i18n="confRegEmergencyPhone">Emergency Contact Phone</span> <span class="required">*</span></label>
            <input type="tel" id="emergencyPhone" required>
          </div>
        </div>

        <div class="form-group">
          <label><span data-i18n="confRegEmergencyRelationship">Relationship</span> <span class="required">*</span></label>
          <input type="text" id="emergencyRelationship" data-i18n-placeholder="confRegEmergencyRelationshipPlaceholder" placeholder="e.g., Spouse, Parent, Friend" required>
        </div>

        <div class="form-group" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 1.25rem; border-radius: 6px; border-left: 4px solid #f59e0b; margin-top: 1rem;">
          <div style="display: flex; align-items: start; gap: 0.75rem;">
            <input type="checkbox" id="emergencyContactAuthorization" required style="margin-top: 0.25rem; width: auto; flex-shrink: 0;">
            <label for="emergencyContactAuthorization" style="margin: 0; font-weight: 600;">
              <span class="required" style="margin-right: 0.25rem;">*</span>
              <span data-i18n="confRegEmergencyAuth">I authorize ISRS conference administrators to contact my designated emergency contact in the event of a medical emergency or other urgent situation during the conference.</span>
            </label>
          </div>
        </div>

        <!-- Special Events & Activities -->
        <h3 style="font-family: 'Marcellus', Georgia, serif; color: var(--primary-blue); margin: 2rem 0 1rem 0; padding-top: 2rem; border-top: 2px solid var(--border-color);" data-i18n="confRegSpecialEvents">Special Events & Activities</h3>
        <p style="margin-bottom: 1.5rem; color: var(--text-light);" data-i18n="confRegSpecialEventsDesc">Select the special events and activities you'd like to attend. Some events may have additional fees.</p>

        <div class="form-group">
          <label style="display: flex; align-items: center; margin-bottom: 1rem;">
            <input type="checkbox" id="welcomeReception" style="width: auto; margin-right: 0.75rem;">
            <span><strong data-i18n="confRegWelcomeReception">Welcome Reception</strong> - <span data-i18n="confRegWelcomeReceptionDesc">Join us for the opening night reception (Included in registration)</span></span>
          </label>

          <label style="display: flex; align-items: center; margin-bottom: 1rem;">
            <input type="checkbox" id="lowCountryBoil" style="width: auto; margin-right: 0.75rem;">
            <span><strong data-i18n="confRegLowCountryBoil">Low Country Boil Dinner</strong> - <span data-i18n="confRegLowCountryBoilDesc">Traditional seafood feast with colleagues (Included in registration)</span></span>
          </label>
        </div>

        <!-- Field Trips -->
        <div class="form-group">
          <label><strong data-i18n="confRegFieldTrips">Field Trips</strong> (<span data-i18n="confRegFieldTripsDesc">Select all that interest you - limited capacity, additional fees may apply</span>)</label>
          <div style="margin-top: 0.75rem;">
            <label style="display: flex; align-items: center; margin-bottom: 0.75rem;">
              <input type="checkbox" id="dolphinTours" style="width: auto; margin-right: 0.75rem;">
              <span data-i18n="confRegDolphinTours">Dolphin Watching Tours - Guided coastal wildlife tour</span>
            </label>
            <label style="display: flex; align-items: center; margin-bottom: 0.75rem;">
              <input type="checkbox" id="seaTurtleCenter" style="width: auto; margin-right: 0.75rem;">
              <span data-i18n="confRegSeaTurtleCenter">Sea Turtle Center Visit - Educational tour of conservation facility</span>
            </label>
            <label style="display: flex; align-items: center; margin-bottom: 0.75rem;">
              <input type="checkbox" id="restorationSiteTour" style="width: auto; margin-right: 0.75rem;">
              <span data-i18n="confRegRestorationSiteTour">Local Restoration Site Tour - Visit active restoration projects</span>
            </label>
          </div>
        </div>

        <!-- Special Activities -->
        <div class="form-group">
          <label style="display: flex; align-items: center; margin-bottom: 1rem;">
            <input type="checkbox" id="golfTournament" style="width: auto; margin-right: 0.75rem;">
            <span><strong data-i18n="confRegGolfTournament">Golf Tournament</strong> - <span data-i18n="confRegGolfTournamentDesc">Networking golf tournament (Additional fee: $75)</span></span>
          </label>
        </div>

        <!-- T-Shirt Size -->
        <div class="form-row">
          <div class="form-group">
            <label data-i18n="confRegTshirtSize">Conference T-Shirt Size (Optional)</label>
            <select id="tshirtSize">
              <option value="" data-i18n="confRegNoTshirt">No t-shirt needed</option>
              <option value="XS">Extra Small (XS)</option>
              <option value="S">Small (S)</option>
              <option value="M">Medium (M)</option>
              <option value="L">Large (L)</option>
              <option value="XL">Extra Large (XL)</option>
              <option value="2XL">2XL</option>
              <option value="3XL">3XL</option>
            </select>
          </div>

          <div class="form-group">
            <label data-i18n="confRegGuests">Bringing a Guest to Social Events?</label>
            <select id="guestCount">
              <option value="0" data-i18n="confRegNoGuests">No guests</option>
              <option value="1" data-i18n="confRegOneGuest">1 guest (+$150)</option>
              <option value="2" data-i18n="confRegTwoGuests">2 guests (+$300)</option>
            </select>
            <small data-i18n="confRegGuestsHint">Guests may attend social events and meals (additional fee applies)</small>
          </div>
        </div>

        <!-- Continuing Education Credits -->
        <div class="form-group">
          <label style="display: flex; align-items: center; margin-bottom: 1rem;">
            <input type="checkbox" id="continuingEducation" style="width: auto; margin-right: 0.75rem;">
            <span><strong data-i18n="confRegContinuingEd">Request Continuing Education Credits</strong> - <span data-i18n="confRegContinuingEdDesc">Society for Ecological Restoration (SER) CE credits</span></span>
          </label>
          <div id="ceDetails" style="display: none; margin-left: 2rem; background: var(--light-gray); padding: 1rem; border-radius: 4px;">
            <div class="form-group" style="margin-bottom: 0.5rem;">
              <label data-i18n="confRegLicenseNumber">Professional License Number (if applicable)</label>
              <input type="text" id="licenseNumber" data-i18n-placeholder="confRegLicenseNumberPlaceholder" placeholder="e.g., PWS #12345">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
              <label data-i18n="confRegLicensingOrg">Licensing Organization</label>
              <input type="text" id="licensingOrg" data-i18n-placeholder="confRegLicensingOrgPlaceholder" placeholder="e.g., Society for Ecological Restoration">
            </div>
          </div>
        </div>

        <!-- Accommodation Preferences -->
        <h3 style="font-family: 'Marcellus', Georgia, serif; color: var(--primary-blue); margin: 2rem 0 1rem 0; padding-top: 2rem; border-top: 2px solid var(--border-color);" data-i18n="confRegAccommodation">Accommodation Preferences</h3>

        <div class="checkbox-group">
          <div class="checkbox-item">
            <input type="checkbox" id="needsAccommodation">
            <label for="needsAccommodation" data-i18n="confRegNeedsAccommodation">I need help booking accommodation</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="roomSharing">
            <label for="roomSharing" data-i18n="confRegRoomSharing">I'm interested in sharing a room to reduce costs</label>
          </div>
        </div>

        <div class="form-group" id="roomPreferences" style="display: none; background: var(--light-gray); padding: 1rem; border-radius: 4px;">
          <label data-i18n="confRegRoommatePrefs">Roommate Preferences/Notes</label>
          <textarea id="roommateNotes" rows="2" data-i18n-placeholder="confRegRoommatePlaceholder" placeholder="Any preferences for a roommate? Gender preference, quiet vs social, etc."></textarea>
        </div>

        <!-- Other Preferences -->
        <h3 style="font-family: 'Marcellus', Georgia, serif; color: var(--primary-blue); margin: 2rem 0 1rem 0; padding-top: 2rem; border-top: 2px solid var(--border-color);" data-i18n="confRegAdditionalInfo">Additional Information</h3>

        <div class="checkbox-group">
          <div class="checkbox-item">
            <input type="checkbox" id="willingVolunteer">
            <label for="willingVolunteer" data-i18n="confRegWillingVolunteer">Willing to volunteer during the conference</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="firstTimeAttendee">
            <label for="firstTimeAttendee" data-i18n="confRegFirstTimeAttendee">This is my first ISRS/ICSR conference</label>
          </div>
        </div>

        <div class="checkbox-group">
          <div class="checkbox-item">
            <input type="checkbox" id="optInMailingList" checked>
            <label for="optInMailingList" data-i18n="confRegOptInMailing">Join ISRS mailing list</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="optInFutureConferences" checked>
            <label for="optInFutureConferences" data-i18n="confRegOptInFuture">Receive updates about future conferences</label>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="prevStep()" data-i18n="confRegBack">Back</button>
          <button type="button" class="btn btn-primary" onclick="nextStep()" data-i18n="confRegNext">Next</button>
        </div>
      </div>

      <!-- Step 3: Session Selection -->
      <div class="form-section" data-step="3">
        <h2 class="section-title" data-i18n="confRegSelectSessions">Select Your Sessions & Workshops</h2>

        <p style="color: var(--text-light); margin-bottom: 2rem;" data-i18n="confRegSessionsDesc">
          Choose the workshops and sessions you'd like to attend. Some sessions have limited capacity and may have a waitlist. <strong>Session selection is optional</strong> - you can skip this step if you're not interested in specific sessions.
        </p>

        <div id="sessionsLoading" style="text-align: center; padding: 3rem;">
          <div class="spinner" style="margin: 0 auto 1rem;"></div>
          <p data-i18n="confRegLoadingSessions">Loading available sessions...</p>
        </div>

        <div id="sessionsContainer" style="display: none;">
          <!-- Sessions will be populated here by JavaScript -->
        </div>

        <div id="sessionsError" style="display: none; padding: 2rem; text-align: center; color: #721c24; background: #f8d7da; border-radius: 4px;">
          <p style="margin-bottom: 0.5rem; font-weight: 600;" data-i18n="confRegSessionsError">Unable to load sessions</p>
          <p style="font-size: 0.9rem;" data-i18n="confRegSessionsErrorDesc">You can continue with registration and add sessions later, or try refreshing the page.</p>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="prevStep()" data-i18n="confRegBack">Back</button>
          <button type="button" class="btn btn-primary" onclick="nextStep()" data-i18n="confRegContinueReview">Continue to Review</button>
        </div>
      </div>

      <!-- Step 4: Review & Payment -->
      <div class="form-section" data-step="4">
        <h2 class="section-title" data-i18n="confRegReviewPayment">Review & Payment</h2>

        <div id="registrationSummary"></div>

        <div class="fee-summary">
          <h3 data-i18n="confRegFeeSummary">Registration Fee</h3>
          <div class="fee-item">
            <span id="feeType" data-i18n="confRegType">Registration Type</span>
            <span id="feeAmount">$0.00</span>
          </div>
          <div class="fee-item">
            <strong data-i18n="confRegTotal">Total</strong>
            <strong id="totalAmount">$0.00</strong>
          </div>
        </div>

        <div class="form-group" style="margin-top: 2rem;">
          <label><span data-i18n="confRegPaymentMethod">Payment Method</span> <span class="required">*</span></label>
          <select id="paymentMethod" required onchange="togglePaymentInstructions()">
            <option value="" data-i18n="confRegSelectPayment">Select payment method...</option>
            <option value="stripe" data-i18n="confRegOnlinePayment">Online Payment (Credit/Debit Card via Stripe)</option>
            <option value="bank_transfer" data-i18n="confRegBankTransfer">Bank Transfer</option>
          </select>
        </div>

        <!-- Stripe Payment Info -->
        <div id="stripeInfo" style="display: none; background: #f0f9ff; border: 2px solid #3b82f6; padding: 1.5rem; border-radius: 4px; margin-top: 1rem;">
          <h4 style="color: var(--primary-blue); margin-bottom: 0.5rem;" data-i18n="confRegZeffyTitle">üí≥ Secure Online Payment via Stripe</h4>
          <p style="margin-bottom: 1rem;"><span data-i18n="confRegZeffyDesc1">ISRS uses Stripe, a secure payment platform trusted by millions worldwide.</span> <span data-i18n="confRegZeffyDesc2">When you proceed to payment, you'll enter your card details securely on this page.</span></p>

          <!-- Fee Coverage Option -->
          <div style="background: #fff; border: 1px solid #3b82f6; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
            <input type="checkbox" id="coverFees" style="margin-right: 0.5rem;" onchange="updateTotalWithFees()">
            <label for="coverFees" style="font-size: 0.95rem;">
              <strong>Help us cover payment processing fees</strong> (adds approximately 3%)
            </label>
            <p style="margin: 0.5rem 0 0 1.75rem; font-size: 0.875rem; color: #64748b;">
              Payment processing fees are <span id="feeAmount">$0.00</span>. By covering these fees, 100% of your registration fee supports ISRS.
            </p>
          </div>

          <!-- Updated Total Display -->
          <div style="background: #fff; border: 1px solid #3b82f6; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
              <span style="font-weight: 600;">Registration Fee:</span>
              <span id="baseAmountDisplay">$0.00</span>
            </div>
            <div id="feeLineItem" style="display: none; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; color: #64748b; font-size: 0.95rem;">
              <span>Processing Fees:</span>
              <span id="feeAmountDisplay">$0.00</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 0.5rem; border-top: 2px solid #e5e7eb;">
              <span style="font-weight: 700; font-size: 1.1rem;">Total:</span>
              <span id="finalTotalDisplay" style="font-weight: 700; font-size: 1.1rem;">$0.00</span>
            </div>
          </div>

          <!-- Stripe Payment Element Container -->
          <div id="payment-element" style="margin-bottom: 1rem;">
            <!-- Stripe.js will insert the Payment Element here -->
          </div>

          <p style="margin: 0; font-size: 0.875rem; color: #64748b;">
            <em>üîí Powered by Stripe - Your payment information is encrypted and secure</em>
          </p>
        </div>

        <!-- Bank Transfer Info -->
        <div id="bankTransferInfo" style="display: none; background: #fef3c7; border: 2px solid #f59e0b; padding: 1.5rem; border-radius: 4px; margin-top: 1rem;">
          <h4 style="color: #92400e; margin-bottom: 0.5rem;" data-i18n="confRegBankTitle">üè¶ Bank Transfer Instructions</h4>
          <p style="margin-bottom: 1rem;" data-i18n="confRegBankDesc">Please transfer the registration fee to the following ISRS bank account:</p>
          <div style="background: white; padding: 1rem; border-radius: 4px; font-family: monospace; margin-bottom: 1rem;">
            <p style="margin: 0.25rem 0;"><strong data-i18n="confRegBankName">Bank Name:</strong> Chase Bank</p>
            <p style="margin: 0.25rem 0;"><strong data-i18n="confRegAccountName">Account Name:</strong> The International Shellfish Restoration Society</p>
            <p style="margin: 0.25rem 0;"><strong data-i18n="confRegAccountNumber">Account Number:</strong> 735867718</p>
            <p style="margin: 0.25rem 0;"><strong data-i18n="confRegRoutingACH">Routing Number (ACH/Direct Deposit):</strong> 044000037</p>
            <p style="margin: 0.25rem 0;"><strong data-i18n="confRegRoutingWire">Routing Number (Wire Transfer):</strong> 021000021</p>
            <p style="margin: 0.25rem 0;"><strong data-i18n="confRegSwiftCode">SWIFT Code:</strong> CHASUS33 <span data-i18n="confRegSwiftNote">(for international wire transfers)</span></p>
          </div>
          <p style="margin-bottom: 0.5rem;"><strong data-i18n="confRegBankImportant">Important:</strong></p>
          <ul style="margin-left: 1.5rem; line-height: 1.8;">
            <li data-i18n="confRegBankInstr1">Include your registration number in the transfer reference</li>
            <li><span data-i18n="confRegBankInstr2">Send proof of transfer to</span> <a href="mailto:treasurer@shellfish-society.org" style="color: #2563eb;">treasurer@shellfish-society.org</a></li>
            <li data-i18n="confRegBankInstr3">Your registration will be confirmed once payment is received (typically 3-5 business days)</li>
          </ul>
        </div>

        <!-- Legal Agreements -->
        <div style="background: #f9fafb; border: 1px solid var(--border-color); padding: 1.25rem; border-radius: 6px; margin-top: 1.5rem;">
          <div style="margin-bottom: 0.75rem;">
            <input type="checkbox" id="agreeTerms" required style="margin-right: 0.5rem;">
            <label for="agreeTerms" style="font-size: 0.95rem;">
              <span class="required" style="margin-right: 0.25rem;">*</span>
              <span data-i18n="confRegAgreeTerms">I agree to the</span> <a href="/legal/terms.html" target="_blank" style="color: var(--primary-blue); text-decoration: underline;" data-i18n="confRegTermsLink">Terms and Conditions</a>
            </label>
          </div>
          <div style="margin-bottom: 0.75rem;">
            <input type="checkbox" id="agreePrivacy" required style="margin-right: 0.5rem;">
            <label for="agreePrivacy" style="font-size: 0.95rem;">
              <span class="required" style="margin-right: 0.25rem;">*</span>
              <span data-i18n="confRegAgreePrivacy">I acknowledge the</span> <a href="/legal/privacy.html" target="_blank" style="color: var(--primary-blue); text-decoration: underline;" data-i18n="confRegPrivacyLink">Privacy Policy</a>
            </label>
          </div>
          <div>
            <input type="checkbox" id="agreeCodeOfConduct" required style="margin-right: 0.5rem;">
            <label for="agreeCodeOfConduct" style="font-size: 0.95rem;">
              <span class="required" style="margin-right: 0.25rem;">*</span>
              <span data-i18n="confRegAgreeCode">I agree to follow the</span> <a href="/legal/code-of-conduct.html" target="_blank" style="color: var(--primary-blue); text-decoration: underline;" data-i18n="confRegCodeLink">Code of Conduct</a>
            </label>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="prevStep()" data-i18n="confRegBack">Back</button>
          <button type="button" class="btn btn-primary" onclick="submitRegistration()" data-i18n="confRegCompleteBtn">Complete Registration</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Stay Connected -->
  <div id="stay-connected"></div>
  </main>

  <footer id="site-footer"></footer>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <p data-i18n="confRegProcessing">Processing your registration...</p>
    </div>
  </div>

  <script>
    const API_BASE_URL = ''  // Use same-origin (relative URLs) in production;
    let currentStep = 1;
    let conferenceData = null;
    let profileId = null;

    let registrationId = null;
    let registrationFee = 0;

    // Fee structure (Early Bird Period)
    const FEES = {
      early_bird: 350.00,
      student: 250.00
    };

    // Discount code management
    let appliedDiscount = null;

    async function validateDiscountCode() {
      const codeInput = document.getElementById('discountCode');
      const code = codeInput.value.trim().toUpperCase();
      const errorDiv = document.getElementById('discountError');
      const successDiv = document.getElementById('discountSuccess');
      const applyBtn = document.getElementById('applyDiscountBtn');
      const registrationType = document.getElementById('registrationType').value;
      const email = document.getElementById('email').value;

      // Clear previous messages
      errorDiv.style.display = 'none';
      successDiv.style.display = 'none';

      if (!code) {
        errorDiv.textContent = 'Please enter a discount code';
        errorDiv.style.display = 'block';
        return;
      }

      if (!registrationType) {
        errorDiv.textContent = 'Please select a registration type first';
        errorDiv.style.display = 'block';
        return;
      }

      if (!conferenceData) {
        errorDiv.textContent = 'Conference data not loaded. Please refresh the page.';
        errorDiv.style.display = 'block';
        return;
      }

      // Disable button and show loading
      applyBtn.disabled = true;
      applyBtn.textContent = 'Validating...';

      try {
        const response = await fetch(`${API_BASE_URL}/api/conference/discount-code/validate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            code: code,
            conferenceId: conferenceData.id,
            registrationType: registrationType,
            attendeeCount: 1,
            userEmail: email
          })
        });

        const result = await response.json();

        if (result.success) {
          appliedDiscount = result.data;
          successDiv.style.display = 'block';

          const descSpan = document.getElementById('discountDescription').querySelector('span');
          descSpan.textContent = result.data.description;

          if (result.data.discountType === 'percentage') {
            document.getElementById('discountAmount').textContent =
              `You'll save ${result.data.discountValue}% on your registration fee`;
          } else {
            document.getElementById('discountAmount').textContent =
              `You'll save $${result.data.discountValue.toFixed(2)} on your registration fee`;
          }

          // Disable input and button after successful application
          codeInput.disabled = true;
          applyBtn.style.display = 'none';

          // Update pricing summary
          updatePricingSummary();

        } else {
          errorDiv.textContent = result.error || 'Invalid discount code';
          errorDiv.style.display = 'block';
          appliedDiscount = null;
        }
      } catch (error) {
        console.error('Error validating discount code:', error);
        errorDiv.textContent = 'Failed to validate discount code. Please try again.';
        errorDiv.style.display = 'block';
        appliedDiscount = null;
      } finally {
        applyBtn.disabled = false;
        applyBtn.textContent = 'Apply Code';
      }
    }

    function removeDiscount() {
      appliedDiscount = null;
      document.getElementById('discountCode').value = '';
      document.getElementById('discountCode').disabled = false;
      document.getElementById('discountError').style.display = 'none';
      document.getElementById('discountSuccess').style.display = 'none';
      document.getElementById('applyDiscountBtn').style.display = 'inline-block';
      updatePricingSummary();
    }

    function updatePricingSummary() {
      const registrationType = document.getElementById('registrationType').value;
      if (!registrationType) return;

      const baseFee = FEES[registrationType] || 0;
      let finalFee = baseFee;
      let discountAmount = 0;

      if (appliedDiscount) {
        if (appliedDiscount.discountType === 'percentage') {
          discountAmount = (baseFee * appliedDiscount.discountValue) / 100;
        } else if (appliedDiscount.discountType === 'fixed_amount') {
          discountAmount = Math.min(appliedDiscount.discountValue, baseFee);
        }
        finalFee = baseFee - discountAmount;
      }

      // Update any fee displays on the page
      const feeDisplays = document.querySelectorAll('.registration-fee-display');
      feeDisplays.forEach(display => {
        if (appliedDiscount) {
          display.innerHTML = `
            <div style="text-decoration: line-through; color: var(--text-light);">$${baseFee.toFixed(2)}</div>
            <div style="font-size: 1.3rem; font-weight: 700; color: var(--primary-blue);">$${finalFee.toFixed(2)}</div>
            <div style="font-size: 0.9rem; color: #28a745;">You save: $${discountAmount.toFixed(2)}</div>
          `;
        } else {
          display.innerHTML = `
            <div style="font-size: 1.3rem; font-weight: 700; color: var(--primary-blue);">$${finalFee.toFixed(2)}</div>
          `;
        }
      });
    }

    // Event selection management
    let selectedEvents = [];
    let availableEvents = [];
    const PYTHON_API_BASE = 'https://isrs-python-backend.onrender.com';

    async function loadSessions() {
      if (!conferenceData || !conferenceData.id) {
        document.getElementById('sessionsLoading').style.display = 'none';
        document.getElementById('sessionsError').style.display = 'block';
        return;
      }

      try {
        const token = localStorage.getItem('isrs_session_token');
        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};

        const response = await fetch(
          `${PYTHON_API_BASE}/conferences/${conferenceData.id}/events`,
          { headers }
        );

        if (!response.ok) {
          throw new Error('Failed to load events');
        }

        const events = await response.json();

        if (events && events.length > 0) {
          availableEvents = events;
          renderSessions();
          document.getElementById('sessionsLoading').style.display = 'none';
          document.getElementById('sessionsContainer').style.display = 'block';
        } else {
          // No events available - not an error, just show a message
          document.getElementById('sessionsLoading').style.display = 'none';
          document.getElementById('sessionsContainer').innerHTML = `
            <div class="no-sessions-message">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto 1rem; opacity: 0.3;">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
              <p>No events are currently available for selection.</p>
              <p style="font-size: 0.95rem;">Check back later or continue with your registration.</p>
            </div>
          `;
          document.getElementById('sessionsContainer').style.display = 'block';
        }
      } catch (error) {
        console.error('Error loading events:', error);
        document.getElementById('sessionsLoading').style.display = 'none';
        document.getElementById('sessionsError').style.display = 'block';
      }
    }

    function renderSessions() {
      const container = document.getElementById('sessionsContainer');

      if (!availableEvents || availableEvents.length === 0) {
        container.innerHTML = `
          <div class="no-sessions-message">
            <p>No events are currently available for selection.</p>
          </div>
        `;
        return;
      }

      // Group events by date
      const eventsByDate = {};
      availableEvents.forEach(event => {
        const date = event.event_date ? event.event_date.split('T')[0] : 'TBD';
        if (!eventsByDate[date]) {
          eventsByDate[date] = [];
        }
        eventsByDate[date].push(event);
      });

      let html = '';
      Object.keys(eventsByDate).sort().forEach(date => {
        html += `
          <h3 class="session-date-header">
            ${date !== 'TBD' ? new Date(date + 'T00:00:00').toLocaleDateString('en-US', {
              weekday: 'long',
              month: 'long',
              day: 'numeric',
              year: 'numeric'
            }) : 'Date To Be Determined'}
          </h3>
        `;

        eventsByDate[date].forEach(event => {
          const isSelected = selectedEvents.includes(event.id);
          const isFull = event.is_full || false;
          const spotsRemaining = event.spots_remaining;

          let availabilityBadgeClass = 'available';
          let availabilityBadgeText = 'Available';

          if (isFull) {
            availabilityBadgeClass = 'waitlist';
            availabilityBadgeText = event.waitlist_count > 0 ? `Waitlist (${event.waitlist_count})` : 'Full';
          } else if (event.capacity && spotsRemaining !== null && spotsRemaining < 10) {
            availabilityBadgeClass = 'limited';
            availabilityBadgeText = `${spotsRemaining} spots left`;
          }

          const canSelect = event.status === 'open';

          html += `
            <div class="session-card ${isSelected ? 'selected' : ''} ${!canSelect ? 'full' : ''}"
                 onclick="${canSelect ? `toggleSession('${event.id}')` : ''}"
                 id="session-${event.id}">
              <div class="session-header">
                <div style="flex: 1;">
                  <div class="session-title">${event.name}</div>
                  <div class="session-meta">
                    ${event.event_date ? new Date(event.event_date).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : ''}
                    ${event.capacity ? `‚Ä¢ Capacity: ${event.current_signups}/${event.capacity}` : ''}
                  </div>
                </div>
                <div class="session-badges">
                  ${event.event_type ? `<span class="session-badge ${event.event_type.toLowerCase().replace(' ', '-')}">${event.event_type}</span>` : ''}
                  <span class="session-badge ${availabilityBadgeClass}">${availabilityBadgeText}</span>
                </div>
              </div>
              ${event.description ? `
                <p class="session-description">${event.description}</p>
              ` : ''}
              ${event.allows_guests ? `
                <div class="session-chair">Guests welcome (additional fee applies)</div>
              ` : ''}
              ${event.fee_per_person > 0 ? `
                <div class="session-fee-notice">
                  <strong>Fee:</strong> $${parseFloat(event.fee_per_person).toFixed(2)} per person
                </div>
              ` : ''}
              ${isSelected ? `
                <div style="margin-top: 0.75rem; padding: 0.5rem; background: #d4edda; border-radius: 4px; color: #155724; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                  <span>Selected</span>
                </div>
              ` : ''}
              ${event.user_signup ? `
                <div style="margin-top: 0.75rem; padding: 0.5rem; background: #fff3cd; border-radius: 4px; color: #856404; font-size: 0.9rem;">
                  Already signed up ${event.user_signup.status === 'waitlist' ? '(Waitlist)' : ''}
                </div>
              ` : ''}
            </div>
          `;
        });
      });

      container.innerHTML = html;
    }

    function toggleSession(eventId) {
      const event = availableEvents.find(e => e.id === eventId);
      if (!event) return;

      // Check if already signed up
      if (event.user_signup) {
        showError('You are already signed up for this event.');
        setTimeout(() => hideError(), 3000);
        return;
      }

      // Check if full
      const isFull = event.is_full || false;
      if (isFull && event.status !== 'open') {
        showError('This event is full.');
        setTimeout(() => hideError(), 3000);
        return;
      }

      const index = selectedEvents.indexOf(eventId);
      if (index > -1) {
        // Remove selection
        selectedEvents.splice(index, 1);
      } else {
        // Add selection
        selectedEvents.push(eventId);
      }

      renderSessions();
    }

    // Load conference data on page load
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        const response = await fetch(`${API_BASE_URL}/api/conference/active`);
        const data = await response.json();

        if (data.success) {
          conferenceData = data.data;
        } else {
          showError('Unable to load conference information. Please try again later.');
        }
      } catch (error) {
        console.error('Error loading conference:', error);
        showError('Unable to connect to registration system. Please try again later.');
      }

      // Add email lookup functionality for auto-fill
      const emailField = document.getElementById('email');
      if (emailField) {
        emailField.addEventListener('blur', lookupProfileByEmail);
      }
    });

    // Lookup profile by email and auto-fill form
    async function lookupProfileByEmail() {
      const emailField = document.getElementById('email');
      const email = emailField?.value?.trim();

      if (!email || !email.includes('@')) {
        return; // Don't lookup if email is empty or invalid
      }

      try {
        // Show subtle loading indicator
        emailField.style.borderColor = '#3b82f6';
        emailField.style.opacity = '0.7';

        // Call membership lookup API
        const response = await fetch(`${API_BASE_URL}/api/membership/lookup?email=${encodeURIComponent(email)}`);
        const result = await response.json();

        // Reset email field styling
        emailField.style.borderColor = '';
        emailField.style.opacity = '';

        if (result.success && result.found) {
          // Profile found - auto-fill the form
          const member = result.data;
          autoFillProfile(member);
          showWelcomeBackMessage(member.first_name);

          // Track returning user in analytics
          if (window.ISRSAnalytics) {
            window.ISRSAnalytics.trackEvent('profile_autofill', {
              membership_type: member.membership_type
            });
          }
        }
      } catch (error) {
        console.error('Profile lookup error:', error);
        emailField.style.borderColor = '';
        emailField.style.opacity = '';
        // Silently fail - don't disrupt user experience
      }
    }

    // Auto-fill form with member data
    function autoFillProfile(member) {
      // Helper function to safely set field value
      const setField = (id, value) => {
        const field = document.getElementById(id);
        if (field && value) {
          field.value = value;
          // Trigger change event for any dependent logic
          field.dispatchEvent(new Event('change', { bubbles: true }));
        }
      };

      // Fill personal information
      setField('firstName', member.first_name);
      setField('lastName', member.last_name);
      setField('organizationName', member.organization_name);
      setField('position', member.position);
      setField('country', member.country);
      setField('state', member.state_province);
      setField('city', member.city);
      setField('phone', member.phone);

      // Mark fields as auto-filled (add subtle background)
      const autoFilledFields = [
        'firstName', 'lastName', 'organizationName', 'position',
        'country', 'state', 'city', 'phone'
      ];

      autoFilledFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field && field.value) {
          field.style.background = 'linear-gradient(135deg, rgba(91, 192, 190, 0.05) 0%, rgba(46, 90, 138, 0.05) 100%)';
          field.style.transition = 'background 0.3s ease';

          // Remove highlight after user edits
          field.addEventListener('input', function() {
            this.style.background = '';
          }, { once: true });
        }
      });
    }

    // Show "Welcome Back" message
    function showWelcomeBackMessage(firstName) {
      const headerElement = document.querySelector('.registration-header p:last-child');

      if (headerElement) {
        const welcomeMessage = document.createElement('div');
        welcomeMessage.id = 'welcomeBackMessage';
        welcomeMessage.style.cssText = `
          background: linear-gradient(135deg, rgba(91, 192, 190, 0.15) 0%, rgba(46, 90, 138, 0.15) 100%);
          color: var(--primary-blue);
          padding: 1rem 1.5rem;
          border-radius: 6px;
          margin-top: 1rem;
          border-left: 4px solid var(--accent-teal);
          font-weight: 600;
          animation: slideDown 0.3s ease;
        `;
        welcomeMessage.innerHTML = `
          <span style="font-size: 1.2rem;">üëã</span>
          Welcome back, ${firstName}! We've pre-filled your information. Please review and update as needed.
        `;

        headerElement.parentNode.insertBefore(welcomeMessage, headerElement.nextSibling);

        // Add animation
        const style = document.createElement('style');
        style.textContent = `
          @keyframes slideDown {
            from {
              opacity: 0;
              transform: translateY(-10px);
            }
            to {
              opacity: 1;
              transform: translateY(0);
            }
          }
        `;
        document.head.appendChild(style);
      }
    }


    // Clear registration form fields
    function clearRegistrationForm() {
      const fieldIds = [
        'firstName', 'lastName', 'email', 'organizationName', 'position',
        'country', 'state', 'city', 'phone', 'dietaryRestrictions',
        'accessibility', 'shirtSize', 'emergencyContactName',
        'emergencyContactPhone', 'emergencyContactEmail', 'relationship'
      ];

      fieldIds.forEach(id => {
        const field = document.getElementById(id);
        if (field) {
          field.value = '';
          field.style.background = '';
        }
      });

      // Clear checkboxes
      const checkboxes = document.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(cb => cb.checked = false);

      // Remove welcome back message if present
      const welcomeMsg = document.getElementById('welcomeBackMessage');
      if (welcomeMsg) {
        welcomeMsg.remove();
      }
    }

    function nextStep() {
      if (!validateStep(currentStep)) {
        return;
      }

      // Hide current step
      document.querySelector(`[data-step="${currentStep}"].form-section`).classList.remove('active');
      document.querySelector(`[data-step="${currentStep}"].progress-step`).classList.add('completed');

      // Show next step
      currentStep++;
      document.querySelector(`[data-step="${currentStep}"].form-section`).classList.add('active');
      document.querySelector(`[data-step="${currentStep}"].progress-step`).classList.add('active');

      // If moving to session selection step, load sessions
      if (currentStep === 3 && availableSessions.length === 0) {
        loadSessions();
      }

      // If moving to review step, populate summary
      if (currentStep === 4) {
        populateSummary();
      }

      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function prevStep() {
      // Hide current step
      document.querySelector(`[data-step="${currentStep}"].form-section`).classList.remove('active');
      document.querySelector(`[data-step="${currentStep}"].progress-step`).classList.remove('active');

      // Show previous step
      currentStep--;
      document.querySelector(`[data-step="${currentStep}"].form-section`).classList.add('active');
      document.querySelector(`[data-step="${currentStep}"].progress-step`).classList.remove('completed');

      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function validateStep(step) {
      hideError();

      if (step === 1) {
        const firstName = document.getElementById('firstName')?.value?.trim() || '';
        const lastName = document.getElementById('lastName')?.value?.trim() || '';
        const email = document.getElementById('email')?.value?.trim() || '';
        const country = document.getElementById('country')?.value?.trim() || '';

        if (!firstName || !lastName || !email || !country) {
          showError('Please fill in all required fields (marked with *)');
          return false;
        }

        if (!isValidEmail(email)) {
          showError('Please enter a valid email address');
          return false;
        }
      }

      if (step === 2) {
        const registrationType = document.getElementById('registrationType')?.value || '';

        if (!registrationType) {
          showError('Please select a registration type');
          return false;
        }
      }

      return true;
    }

    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function updateFee() {
      const registrationType = document.getElementById('registrationType')?.value || '';

      if (registrationType) {
        const fee = FEES[registrationType];
        registrationFee = fee; // Store for Stripe payment

        document.getElementById('feeAmount').textContent = `$${fee.toFixed(2)}`;
        document.getElementById('totalAmount').textContent = `$${fee.toFixed(2)}`;

        const typeLabels = {
          early_bird: 'Early Bird Registration',
          student: 'Student Registration'
        };
        document.getElementById('feeType').textContent = typeLabels[registrationType];

        // Update Stripe payment display if visible
        if (document.getElementById('stripeInfo').style.display !== 'none') {
          updateTotalWithFees();
        }
      }
    }

    function populateSummary() {
      // Build selected sessions display
      let sessionsHtml = '';
      if (selectedSessions.length > 0) {
        sessionsHtml = `
          <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
            <h4 style="color: var(--primary-blue); margin-bottom: 0.75rem;">Selected Sessions & Workshops</h4>
        `;
        selectedSessions.forEach(sessionId => {
          const session = availableSessions.find(s => s.id === sessionId);
          if (session) {
            sessionsHtml += `
              <div style="padding: 0.75rem; background: #f0f8ff; border-radius: 4px; margin-bottom: 0.5rem; border-left: 3px solid var(--primary-blue);">
                <strong style="color: var(--primary-blue);">${session.session_name}</strong><br>
                <span style="color: var(--text-light); font-size: 0.9rem;">
                  ${new Date(session.session_date + 'T00:00:00').toLocaleDateString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric'
                  })} ‚Ä¢ ${session.start_time}${session.room ? ' ‚Ä¢ ' + session.room : ''}
                </span>
                ${session.requires_additional_fee ? `
                  <span style="display: block; margin-top: 0.25rem; font-size: 0.85rem; color: #f57c00;">
                    Additional fee: $${parseFloat(session.additional_fee || 0).toFixed(2)}
                  </span>
                ` : ''}
              </div>
            `;
          }
        });
        sessionsHtml += '</div>';
      }

      // Build discount display
      let discountHtml = '';
      if (appliedDiscount) {
        const registrationType = document.getElementById('registrationType').value;
        const baseFee = FEES[registrationType] || 0;
        let discountAmount = 0;

        if (appliedDiscount.discountType === 'percentage') {
          discountAmount = (baseFee * appliedDiscount.discountValue) / 100;
        } else if (appliedDiscount.discountType === 'fixed_amount') {
          discountAmount = Math.min(appliedDiscount.discountValue, baseFee);
        }

        discountHtml = `
          <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
            <h4 style="color: var(--primary-blue); margin-bottom: 0.75rem;">Discount Applied</h4>
            <div style="padding: 0.75rem; background: #d4edda; border-radius: 4px; border-left: 3px solid #28a745;">
              <strong style="color: #155724;">${appliedDiscount.code.toUpperCase()}</strong><br>
              <span style="color: #155724; font-size: 0.9rem;">
                ${appliedDiscount.description || 'Discount code applied'} - You save $${discountAmount.toFixed(2)}
              </span>
            </div>
          </div>
        `;
      }

      const summary = `
        <div style="background: var(--light-gray); padding: 1.5rem; border-radius: 4px; margin-bottom: 2rem;">
          <h3 style="font-family: 'Marcellus', Georgia, serif; color: var(--primary-blue); margin-bottom: 1rem;">Registration Summary</h3>
          <p><strong>Name:</strong> ${document.getElementById('firstName').value} ${document.getElementById('lastName').value}</p>
          <p><strong>Email:</strong> ${document.getElementById('email').value}</p>
          <p><strong>Organization:</strong> ${document.getElementById('organizationName').value || 'Not specified'}</p>
          <p><strong>Country:</strong> ${document.getElementById('country').value}</p>
          <p><strong>Registration Type:</strong> ${document.getElementById('registrationType').selectedOptions[0].text}</p>
          <p><strong>Attendance:</strong> ${document.getElementById('attendanceType').value === 'in-person' ? 'In-Person' : 'Virtual'}</p>
          ${discountHtml}
          ${sessionsHtml}
        </div>
      `;

      document.getElementById('registrationSummary').innerHTML = summary;
      updateFee();
    }

    // Stripe variables
    let stripe = null;
    let elements = null;
    let paymentElement = null;

    function togglePaymentInstructions() {
      const method = document.getElementById('paymentMethod').value;
      document.getElementById('stripeInfo').style.display = method === 'stripe' ? 'block' : 'none';
      document.getElementById('bankTransferInfo').style.display = method === 'bank_transfer' ? 'block' : 'none';

      // Initialize Stripe when selected
      if (method === 'stripe' && !stripe) {
        initializeStripe();
      }
    }

    async function initializeStripe() {
      try {
        // Fetch Stripe config from backend
        const configResponse = await fetch(`${API_BASE_URL}/api/stripe/config`);
        const config = await configResponse.json();

        if (!config.publishable_key) {
          throw new Error('Stripe not configured');
        }

        // Initialize Stripe
        stripe = Stripe(config.publishable_key);

        // Update fee display
        updateTotalWithFees();

        console.log('Stripe initialized successfully');
      } catch (error) {
        console.error('Error initializing Stripe:', error);
        showError('Payment system not available. Please try bank transfer or contact us.');
      }
    }

    function updateTotalWithFees() {
      const coverFees = document.getElementById('coverFees')?.checked || false;
      const baseAmount = registrationFee || 0;

      // Calculate fee if covering: (amount + $0.30) / (1 - 0.029)
      let feeAmount = 0;
      let totalAmount = baseAmount;

      if (coverFees && baseAmount > 0) {
        const totalWithFixedFee = baseAmount + 0.30;
        totalAmount = totalWithFixedFee / 0.971;
        feeAmount = totalAmount - baseAmount;
      }

      // Update displays
      document.getElementById('baseAmountDisplay').textContent = `$${baseAmount.toFixed(2)}`;
      document.getElementById('feeAmount').textContent = `$${feeAmount.toFixed(2)}`;
      document.getElementById('feeAmountDisplay').textContent = `$${feeAmount.toFixed(2)}`;
      document.getElementById('finalTotalDisplay').textContent = `$${totalAmount.toFixed(2)}`;

      // Show/hide fee line item
      const feeLineItem = document.getElementById('feeLineItem');
      if (feeLineItem) {
        feeLineItem.style.display = coverFees ? 'flex' : 'none';
      }
    }

    // Toggle state/province field based on country
    function toggleStateField() {
      const country = document.getElementById('country').value;
      const stateFieldGroup = document.getElementById('stateFieldGroup');
      const stateSelect = document.getElementById('state');
      const stateLabel = document.getElementById('stateLabel');

      if (country === 'United States') {
        stateLabel.innerHTML = 'State <span class="required">*</span>';
        stateSelect.innerHTML = '<option value="">Select state...</option>' +
          '<option value="AL">Alabama</option><option value="AK">Alaska</option><option value="AZ">Arizona</option>' +
          '<option value="AR">Arkansas</option><option value="CA">California</option><option value="CO">Colorado</option>' +
          '<option value="CT">Connecticut</option><option value="DE">Delaware</option><option value="FL">Florida</option>' +
          '<option value="GA">Georgia</option><option value="HI">Hawaii</option><option value="ID">Idaho</option>' +
          '<option value="IL">Illinois</option><option value="IN">Indiana</option><option value="IA">Iowa</option>' +
          '<option value="KS">Kansas</option><option value="KY">Kentucky</option><option value="LA">Louisiana</option>' +
          '<option value="ME">Maine</option><option value="MD">Maryland</option><option value="MA">Massachusetts</option>' +
          '<option value="MI">Michigan</option><option value="MN">Minnesota</option><option value="MS">Mississippi</option>' +
          '<option value="MO">Missouri</option><option value="MT">Montana</option><option value="NE">Nebraska</option>' +
          '<option value="NV">Nevada</option><option value="NH">New Hampshire</option><option value="NJ">New Jersey</option>' +
          '<option value="NM">New Mexico</option><option value="NY">New York</option><option value="NC">North Carolina</option>' +
          '<option value="ND">North Dakota</option><option value="OH">Ohio</option><option value="OK">Oklahoma</option>' +
          '<option value="OR">Oregon</option><option value="PA">Pennsylvania</option><option value="RI">Rhode Island</option>' +
          '<option value="SC">South Carolina</option><option value="SD">South Dakota</option><option value="TN">Tennessee</option>' +
          '<option value="TX">Texas</option><option value="UT">Utah</option><option value="VT">Vermont</option>' +
          '<option value="VA">Virginia</option><option value="WA">Washington</option><option value="WV">West Virginia</option>' +
          '<option value="WI">Wisconsin</option><option value="WY">Wyoming</option><option value="DC">Washington DC</option>';
        stateSelect.required = true;
        stateFieldGroup.style.display = 'block';
      } else if (country === 'Canada') {
        stateLabel.innerHTML = 'Province <span class="required">*</span>';
        stateSelect.innerHTML = '<option value="">Select province...</option>' +
          '<option value="AB">Alberta</option><option value="BC">British Columbia</option><option value="MB">Manitoba</option>' +
          '<option value="NB">New Brunswick</option><option value="NL">Newfoundland and Labrador</option>' +
          '<option value="NS">Nova Scotia</option><option value="ON">Ontario</option><option value="PE">Prince Edward Island</option>' +
          '<option value="QC">Quebec</option><option value="SK">Saskatchewan</option><option value="NT">Northwest Territories</option>' +
          '<option value="NU">Nunavut</option><option value="YT">Yukon</option>';
        stateSelect.required = true;
        stateFieldGroup.style.display = 'block';
      } else {
        stateSelect.required = false;
        stateFieldGroup.style.display = 'none';
      }
    }

    // Add event listeners for conditional fields
    document.addEventListener('DOMContentLoaded', () => {
      // Show/hide CE details
      document.getElementById('continuingEducation').addEventListener('change', (e) => {
        document.getElementById('ceDetails').style.display = e.target.checked ? 'block' : 'none';
      });

      // Show/hide room sharing preferences
      document.getElementById('roomSharing').addEventListener('change', (e) => {
        document.getElementById('roomPreferences').style.display = e.target.checked ? 'block' : 'none';
      });
    });

    async function submitRegistration() {
      // Validate payment method is selected
      const paymentMethod = document.getElementById('paymentMethod')?.value || '';
      if (!paymentMethod) {
        showError('Please select a payment method');
        return;
      }

      showLoading();
      hideError();

      try {
        // Get reCAPTCHA token for bot protection
        let recaptchaToken = null;
        if (typeof grecaptcha !== 'undefined' && grecaptcha.enterprise) {
          try {
            // Wrap ready() in a Promise since it expects a callback
            await new Promise((resolve) => {
              grecaptcha.enterprise.ready(resolve);
            });
            recaptchaToken = await grecaptcha.enterprise.execute('6LfnNQAsAAAAALsKryyU06I6fPvdQ_-7YgHAvYeA', {action: 'registration'});
            console.log('‚úÖ reCAPTCHA token obtained');
          } catch (error) {
            console.warn('‚ö†Ô∏è reCAPTCHA token generation failed:', error);
            // Continue anyway - reCAPTCHA is optional for better UX
          }
        }
        // Step 1: Create/update profile
        const researchAreasStr = document.getElementById('researchAreas')?.value || '';
        const researchAreas = researchAreasStr ? researchAreasStr.split(',').map(a => a.trim()) : [];

        const profileData = {
          user_email: document.getElementById('email')?.value || '',
          first_name: document.getElementById('firstName')?.value || '',
          last_name: document.getElementById('lastName')?.value || '',
          organization_name: document.getElementById('organizationName')?.value || '',
          position: document.getElementById('position')?.value || '',
          country: document.getElementById('country')?.value || '',
          state_province: document.getElementById('state')?.value || null,
          city: document.getElementById('city')?.value || '',
          phone: document.getElementById('phone')?.value || '',
          bio: document.getElementById('bio')?.value || '',
          cv_url: document.getElementById('cvUrl')?.value || '',
          research_areas: researchAreas
        };

        const profileResponse = await fetch(`${API_BASE_URL}/api/conference/profile`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(profileData)
        });

        const profileResult = await profileResponse.json();

        if (!profileResult.success) {
          throw new Error(profileResult.error || 'Failed to create profile');
        }

        profileId = profileResult.data.id;

        // Step 2: Create registration
        const registrationType = document.getElementById('registrationType')?.value || '';
        registrationFee = FEES[registrationType] || 0;

        // Calculate guest fee
        const guestCount = parseInt(document.getElementById('guestCount')?.value) || 0;
        const guestFee = guestCount * 150;

        const registrationData = {
          conference_id: conferenceData.id,
          attendee_id: profileId,
          registration_type: registrationType,
          registration_fee: registrationFee + guestFee,
          is_virtual: document.getElementById('attendanceType')?.value === 'virtual',
          is_presenter: document.getElementById('isPresenter')?.checked || false,
          is_first_time: document.getElementById('isFirstTime')?.checked || false,
          dietary_restrictions: document.getElementById('dietaryRestrictions')?.value || '',
          dietary_notes: document.getElementById('dietaryNotes')?.value || '',
          accessibility_needs: document.getElementById('accessibilityNeeds')?.value || '',
          emergency_contact_name: document.getElementById('emergencyName')?.value || '',
          emergency_contact_email: document.getElementById('emergencyEmail')?.value || '',
          emergency_contact_phone: document.getElementById('emergencyPhone')?.value || '',
          emergency_contact_relationship: document.getElementById('emergencyRelationship')?.value || '',
          emergency_contact_authorization: document.getElementById('emergencyContactAuthorization')?.checked || false,
          interested_in_workshops: document.getElementById('interestedWorkshops')?.checked || false,
          interested_in_field_trips: document.getElementById('interestedFieldTrips')?.checked || false,
          interested_in_social_events: document.getElementById('interestedSocialEvents')?.checked || false,
          needs_accommodation_help: document.getElementById('needsAccommodation')?.checked || false,
          willing_to_volunteer: document.getElementById('willingVolunteer')?.checked || false,
          opt_in_mailing_list: document.getElementById('optInMailingList')?.checked || false,
          opt_in_future_conferences: document.getElementById('optInFutureConferences')?.checked || false,

          // Special Events & Activities
          welcome_reception: document.getElementById('welcomeReception')?.checked || false,
          low_country_boil: document.getElementById('lowCountryBoil')?.checked || false,
          dolphin_tours: document.getElementById('dolphinTours')?.checked || false,
          sea_turtle_center: document.getElementById('seaTurtleCenter')?.checked || false,
          restoration_site_tour: document.getElementById('restorationSiteTour')?.checked || false,
          golf_tournament: document.getElementById('golfTournament')?.checked || false,

          // T-Shirt & Guests
          tshirt_size: document.getElementById('tshirtSize')?.value || '',
          guest_count: guestCount,
          guest_fee: guestFee,

          // Continuing Education
          continuing_education: document.getElementById('continuingEducation')?.checked || false,
          license_number: document.getElementById('licenseNumber')?.value || '',
          licensing_org: document.getElementById('licensingOrg')?.value || '',

          // Room Sharing
          room_sharing: document.getElementById('roomSharing')?.checked || false,
          roommate_notes: document.getElementById('roommateNotes')?.value || '',

          // Discount Code
          discount_code: appliedDiscount ? appliedDiscount.code : null,

          // Bot Protection
          recaptcha_token: recaptchaToken
        };

        const regResponse = await fetch(`${API_BASE_URL}/api/conference/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(registrationData)
        });

        const regResult = await regResponse.json();

        if (!regResult.success) {
          throw new Error(regResult.error || 'Failed to create registration');
        }

        registrationId = regResult.data.id;

        // Step 2.5: Register for sessions if any were selected
        if (selectedSessions.length > 0) {
          try {
            const sessionsResponse = await fetch(`${API_BASE_URL}/api/conference/sessions/register`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                registrationId: registrationId,
                sessionIds: selectedSessions
              })
            });

            const sessionsResult = await sessionsResponse.json();

            if (!sessionsResult.success) {
              console.warn('Session registration failed:', sessionsResult.error);
              // Don't fail the entire registration if session registration fails
              // The user can add sessions later
            }
          } catch (sessionError) {
            console.error('Error registering for sessions:', sessionError);
            // Don't fail the entire registration
          }
        }

        // Track registration in Google Analytics
        if (window.ISRSAnalytics) {
          window.ISRSAnalytics.trackFormSubmission('conference_registration');
          window.ISRSAnalytics.trackEvent('registration_completed', {
            registration_type: registrationType,
            payment_method: paymentMethod,
            registration_fee: registrationFee
          });
        }

        // Step 3: Handle payment based on method
        if (paymentMethod === 'stripe') {
          // Process Stripe payment
          const coverFees = document.getElementById('coverFees')?.checked || false;

          try {
            // Create Payment Intent
            const paymentIntentResponse = await fetch(`${API_BASE_URL}/api/stripe/create-payment-intent`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                amount: registrationFee,
                currency: 'usd',
                customer_email: document.getElementById('email').value,
                customer_name: `${document.getElementById('firstName').value} ${document.getElementById('lastName').value}`,
                registration_type: document.getElementById('registrationType').selectedOptions[0].text,
                cover_fees: coverFees,
                metadata: {
                  registration_id: registrationId,
                  attendance_type: document.getElementById('attendanceType').value
                }
              })
            });

            const paymentIntent = await paymentIntentResponse.json();

            if (!paymentIntent.client_secret) {
              throw new Error('Failed to create payment');
            }

            // Create Stripe Elements with Payment Intent
            const appearance = {
              theme: 'stripe',
              variables: {
                colorPrimary: '#1e40af',
                colorBackground: '#ffffff',
                colorText: '#1f2937',
                colorDanger: '#dc2626',
                fontFamily: 'PT Serif, Georgia, serif',
                borderRadius: '4px'
              }
            };

            elements = stripe.elements({
              clientSecret: paymentIntent.client_secret,
              appearance: appearance
            });

            paymentElement = elements.create('payment');
            paymentElement.mount('#payment-element');

            // Update the Complete Registration button to process payment
            hideLoading();
            showSuccess('Payment form loaded. Please enter your payment details below.');

            // Change button to "Pay Now"
            const submitButton = document.querySelector('[onclick="submitRegistration()"]');
            submitButton.textContent = 'Pay Now';
            submitButton.onclick = async () => await processStripePayment(registrationId, paymentIntent.client_secret);

          } catch (error) {
            console.error('Stripe payment setup error:', error);
            throw new Error('Failed to initialize payment. Please try again.');
          }
        } else if (paymentMethod === 'bank_transfer') {
          // Bank transfer - just go to confirmation with instructions
          hideLoading();
          showSuccess('Registration created successfully! Redirecting to payment instructions...');

          setTimeout(() => {
            window.location.href = `/conference/confirmation.html?registration=${registrationId}&method=bank_transfer`;
          }, 2000);
        }

      } catch (error) {
        hideLoading();
        console.error('Registration error:', error);
        showError(error.message || 'Registration failed. Please try again.');
      }
    }

    async function processStripePayment(registrationId, clientSecret) {
      try {
        showLoading();

        // Confirm the payment
        const { error, paymentIntent } = await stripe.confirmPayment({
          elements,
          confirmParams: {
            return_url: `${window.location.origin}/conference/confirmation.html?registration=${registrationId}&method=stripe`,
          },
          redirect: 'if_required'
        });

        if (error) {
          // Payment failed
          hideLoading();
          showError(error.message || 'Payment failed. Please try again.');
          console.error('Stripe payment error:', error);
          return;
        }

        // Payment succeeded
        if (paymentIntent.status === 'succeeded') {
          // Confirm payment with backend
          const confirmResponse = await fetch(`${API_BASE_URL}/api/stripe/confirm-payment`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              payment_intent_id: paymentIntent.id,
              registration_id: registrationId
            })
          });

          const confirmResult = await confirmResponse.json();

          if (confirmResult.success) {
            // Track successful payment
            if (window.ISRSAnalytics) {
              window.ISRSAnalytics.trackEvent('payment_completed', {
                registration_id: registrationId,
                amount: paymentIntent.amount / 100,
                payment_method: 'stripe'
              });
            }

            // Redirect to confirmation page
            hideLoading();
            showSuccess('Payment successful! Redirecting to confirmation...');

            setTimeout(() => {
              window.location.href = `/conference/confirmation.html?registration=${registrationId}&method=stripe&payment_intent=${paymentIntent.id}`;
            }, 2000);
          } else {
            throw new Error('Payment confirmation failed');
          }
        } else {
          throw new Error(`Unexpected payment status: ${paymentIntent.status}`);
        }

      } catch (error) {
        hideLoading();
        console.error('Payment processing error:', error);
        showError(error.message || 'Payment processing failed. Please try again.');
      }
    }

    function showLoading() {
      document.getElementById('loadingOverlay').classList.add('active');
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('active');
    }

    function showError(message) {
      const errorEl = document.getElementById('errorMessage');
      errorEl.textContent = message;
      errorEl.classList.add('active');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function hideError() {
      document.getElementById('errorMessage').classList.remove('active');
    }

    function showSuccess(message) {
      const successEl = document.getElementById('successMessage');
      successEl.textContent = message;
      successEl.classList.add('active');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  </script>

  <script src="/js/components.js?v=2.1.0"></script>
</body>
</html>
