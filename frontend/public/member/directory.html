<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Connect with ISRS members worldwide working in shellfish restoration">
  <title>Member Directory - ISRS</title>
  <link rel="icon" type="image/png" href="/images/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Marcellus&family=PT+Serif:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="/css/admin-unified.css">

  <script src="/js/theme.js"></script>
  <script src="/js/analytics.js"></script>
  <script src="/js/member-auth.js"></script>

  <style>
    .directory-container {
      max-width: 1400px;
      margin: 2rem auto 4rem;
      padding: 0 2rem;
    }

    .filters-section {
      background: var(--admin-surface, #fff);
      border: 1px solid var(--admin-border, #e5e7eb);
      border-radius: var(--admin-radius-md, 6px);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: flex-end;
    }

    .filter-group {
      flex: 1;
      min-width: 200px;
    }

    .filter-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-color);
      font-size: 0.9rem;
    }

    .filter-group input,
    .filter-group select {
      width: 100%;
      padding: 0.6rem 0.75rem;
      border: 1px solid var(--admin-border, #e5e7eb);
      border-radius: var(--admin-radius-sm, 4px);
      font-size: 0.95rem;
      background: var(--admin-surface, #fff);
    }

    .filter-group input:focus,
    .filter-group select:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 2px rgba(26, 82, 118, 0.1);
    }

    /* Table styling consistent with admin tables */
    .directory-table-wrapper {
      background: var(--admin-surface, #fff);
      border: 1px solid var(--admin-border, #e5e7eb);
      border-radius: var(--admin-radius-md, 6px);
      overflow: hidden;
    }

    .directory-table-scroll {
      overflow-x: auto;
    }

    .directory-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    .directory-table thead {
      background: var(--admin-gray-50, #f9fafb);
      border-bottom: 2px solid var(--admin-border, #e5e7eb);
    }

    .directory-table th {
      text-align: left;
      padding: 0.875rem 1rem;
      font-weight: 600;
      color: var(--admin-text-secondary, #6b7280);
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.025em;
      white-space: nowrap;
      cursor: pointer;
      user-select: none;
      transition: background 0.15s;
    }

    .directory-table th:hover {
      background: var(--admin-gray-100, #f3f4f6);
    }

    .directory-table th.sorted-asc::after {
      content: ' \u25B2';
      font-size: 0.7rem;
    }

    .directory-table th.sorted-desc::after {
      content: ' \u25BC';
      font-size: 0.7rem;
    }

    .directory-table tbody tr {
      border-bottom: 1px solid var(--admin-border, #e5e7eb);
      transition: background 0.15s;
    }

    .directory-table tbody tr:hover {
      background: var(--admin-gray-50, #f9fafb);
    }

    .directory-table td {
      padding: 0.75rem 1rem;
      vertical-align: middle;
      color: var(--admin-text, #111827);
    }

    /* Name column with avatar */
    .member-name-cell {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      min-width: 200px;
    }

    .member-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-blue), var(--accent-teal));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.85rem;
      font-weight: 600;
      flex-shrink: 0;
    }

    .member-name-text {
      font-weight: 500;
      color: var(--primary-blue);
    }

    /* Tags/badges */
    .tag {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      background: var(--admin-gray-100, #f3f4f6);
      color: var(--admin-text-secondary, #6b7280);
      border-radius: 3px;
      font-size: 0.75rem;
      margin: 0.1rem;
      white-space: nowrap;
    }

    .tag.conference {
      background: var(--accent-teal);
      color: white;
    }

    .tags-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      max-width: 250px;
    }

    /* Email link */
    .email-link {
      color: var(--primary-blue);
      text-decoration: none;
    }

    .email-link:hover {
      text-decoration: underline;
    }

    /* Bio truncation */
    .bio-cell {
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Stats bar */
    .stats-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      background: var(--admin-gray-50, #f9fafb);
      border-top: 1px solid var(--admin-border, #e5e7eb);
      font-size: 0.875rem;
      color: var(--admin-text-secondary, #6b7280);
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-light);
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    /* Loading state */
    .loading-state {
      text-align: center;
      padding: 3rem;
    }

    .spinner {
      margin: 0 auto 1rem;
      width: 40px;
      height: 40px;
      border: 3px solid var(--admin-border, #e5e7eb);
      border-top-color: var(--primary-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* CTA Section */
    .cta-section {
      margin-top: 2rem;
      text-align: center;
      padding: 2rem;
      background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
      border-radius: var(--admin-radius-md, 6px);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .directory-container {
        padding: 0 1rem;
      }

      .filter-row {
        flex-direction: column;
      }

      .filter-group {
        min-width: 100%;
      }

      .directory-table {
        font-size: 0.85rem;
      }

      .member-avatar {
        width: 30px;
        height: 30px;
        font-size: 0.75rem;
      }
    }
  </style>
</head>
<body>
  <header id="site-header"></header>

  <script>
    // Load header with language switcher
    loadHeader();
  </script>

  <main id="main-content">
    <div class="directory-container">

      <!-- Page Header -->
      <div style="text-align: center; margin-bottom: 2rem;">
        <h1 id="pageHeading" style="color: var(--primary-blue); margin-bottom: 0.5rem;">Member Directory</h1>
        <p id="pageSubtitle" style="font-size: 1.1rem; color: var(--text-light); max-width: 700px; margin: 0 auto 1rem;">
          Connect with researchers, practitioners, and stakeholders working in shellfish restoration worldwide
        </p>
      </div>

      <!-- Search and Filters -->
      <div class="filters-section">
        <div class="filter-row">
          <div class="filter-group" style="flex: 2;">
            <label for="searchInput" id="searchLabel">Search</label>
            <input
              type="text"
              id="searchInput"
              placeholder="Search by name, organization, research areas..."
              onkeyup="handleSearchDebounced()"
            >
          </div>

          <div class="filter-group">
            <label id="countryLabel" for="countryFilter">Country</label>
            <select id="countryFilter" onchange="applyFilters()">
              <option value="">All Countries</option>
            </select>
          </div>

          <div class="filter-group">
            <label id="conferenceLabel" for="conferenceFilter">Conference Year</label>
            <select id="conferenceFilter" onchange="applyFilters()">
              <option value="">All Years</option>
              <option value="2022">ICSR 2022</option>
              <option value="2018">ICSR 2018</option>
              <option value="2015">ICSR 2015</option>
              <option value="2011">ICSR 2011</option>
            </select>
          </div>

          <div class="filter-group" style="flex: 0;">
            <label>&nbsp;</label>
            <button id="clearFiltersBtn" class="btn btn-secondary" onclick="clearFilters()" style="padding: 0.6rem 1.25rem; white-space: nowrap;">
              Clear Filters
            </button>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div id="loadingState" class="loading-state">
        <div class="spinner"></div>
        <p id="loadingText" style="color: var(--text-light);">Loading members...</p>
      </div>

      <!-- Directory Table -->
      <div id="directoryContent" class="directory-table-wrapper" style="display: none;">
        <div class="directory-table-scroll">
          <table class="directory-table">
            <thead id="tableHeader">
              <!-- Dynamic headers -->
            </thead>
            <tbody id="tableBody">
              <!-- Dynamic rows -->
            </tbody>
          </table>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar">
          <span id="resultsCount">0 members</span>
          <span id="visibleColumnsInfo"></span>
        </div>
      </div>

      <!-- Empty State -->
      <div id="emptyState" style="display: none;" class="empty-state">
        <div class="empty-state-icon">üîç</div>
        <h2 id="noMembersHeading" style="color: var(--text-color); margin-bottom: 0.5rem;">No Members Found</h2>
        <p id="noMembersText">Try adjusting your search criteria or filters</p>
      </div>

      <!-- Call to Action (if not logged in) -->
      <div id="ctaSection" class="cta-section">
        <h2 id="ctaHeading" style="color: var(--primary-blue); margin-bottom: 1rem;">Join the ISRS Community</h2>
        <p id="ctaText" style="color: var(--text-color); margin-bottom: 1.5rem; max-width: 600px; margin-left: auto; margin-right: auto;">
          Connect with colleagues, share your research, and stay updated on shellfish restoration initiatives worldwide.
        </p>
        <a id="ctaButton" href="/member/login.html" class="btn btn-primary">Login to Your Profile</a>
      </div>

    </div>
  </main>

  <footer id="site-footer"></footer>

  <script src="/js/components.js?v=2.1.0"></script>

  <script>
    // Load footer
    loadFooter();

    // Update page content with translations
    function updateDirectoryPageText() {
      document.getElementById('pageHeading').textContent = t('memberDirectory');
      document.getElementById('pageSubtitle').textContent = t('directorySubtitle');
      document.getElementById('searchLabel').textContent = t('searchLabel');
      document.getElementById('searchInput').placeholder = t('searchPlaceholder');
      document.getElementById('countryLabel').textContent = t('countryFilterLabel');
      document.getElementById('conferenceLabel').textContent = t('conferenceYearLabel');
      document.getElementById('clearFiltersBtn').textContent = t('clearFiltersBtn');
      document.getElementById('loadingText').textContent = t('loadingMembers');
      document.getElementById('noMembersHeading').textContent = t('noMembersFound');
      document.getElementById('noMembersText').textContent = t('tryAdjustingFilters');
      document.getElementById('ctaHeading').textContent = t('joinISRSCommunity');
      document.getElementById('ctaText').textContent = t('connectColleagues');
      document.getElementById('ctaButton').textContent = t('loginToProfile');

      // Update filter dropdowns
      const countryFilter = document.getElementById('countryFilter');
      if (countryFilter.options[0]) {
        countryFilter.options[0].text = t('allCountries');
      }

      const conferenceFilter = document.getElementById('conferenceFilter');
      if (conferenceFilter.options[0]) {
        conferenceFilter.options[0].text = t('allYears');
      }

      document.title = t('memberDirectory') + ' - ISRS';
    }

    // Initial text update
    updateDirectoryPageText();

    // Listen for language changes
    window.addEventListener('languageChanged', updateDirectoryPageText);

    let allMembers = [];
    let filteredMembers = [];
    let searchTimeout = null;
    let sortColumn = 'full_name';
    let sortDirection = 'asc';

    // Define all possible columns with their display names and data keys
    const allColumns = [
      { key: 'full_name', label: 'Name', alwaysVisible: true },
      { key: 'organization', label: 'Organization', visibilityField: 'organization' },
      { key: 'position', label: 'Position', visibilityField: 'position' },
      { key: 'country', label: 'Country', visibilityField: 'country' },
      { key: 'city', label: 'City', visibilityField: 'city' },
      { key: 'contact_email', label: 'Email', visibilityField: 'contact_email' },
      { key: 'bio', label: 'Bio', visibilityField: 'bio' },
      { key: 'research_areas', label: 'Research Areas', visibilityField: 'research_areas' },
      { key: 'conference_history', label: 'Conferences', visibilityField: 'conference_history' }
    ];

    // Determine which columns have data visible from any member
    function getVisibleColumns() {
      const visibleColumns = [];

      for (const col of allColumns) {
        if (col.alwaysVisible) {
          visibleColumns.push(col);
          continue;
        }

        // Check if any member has this field visible
        const anyMemberHasField = filteredMembers.some(member => {
          const visibleFields = member.directory_visible_fields || {};
          const hasVisibility = visibleFields[col.visibilityField] === true;
          const hasValue = member[col.key] !== null && member[col.key] !== undefined && member[col.key] !== '';
          return hasVisibility && hasValue;
        });

        if (anyMemberHasField) {
          visibleColumns.push(col);
        }
      }

      return visibleColumns;
    }

    // Load directory on page load
    async function loadDirectory() {
      // Check if user is authenticated first
      if (!MemberAuth.isAuthenticated()) {
        document.getElementById('loadingState').innerHTML = `
          <div style="text-align: center; padding: 2rem;">
            <p style="color: var(--primary-blue); font-size: 1.2rem; margin-bottom: 1rem;">üîê Login Required</p>
            <p style="color: var(--text-color); margin-bottom: 1.5rem;">Please log in to view the member directory.</p>
            <a href="/member/login.html?redirect=/member/directory.html" class="btn btn-primary">Login to View Directory</a>
          </div>
        `;
        return;
      }

      try {
        const response = await MemberAuth.getDirectory();

        if (!response.success) {
          throw new Error('Failed to load directory');
        }

        allMembers = response.data || [];
        filteredMembers = allMembers;

        // Populate country filter
        populateCountryFilter();

        // Display members
        displayMembers();

        // Hide loading, show content
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('directoryContent').style.display = 'block';

      } catch (error) {
        console.error('Error loading directory:', error);
        document.getElementById('loadingState').innerHTML = `
          <p style="color: #c00;">Failed to load member directory. Please try refreshing the page.</p>
        `;
      }
    }

    // Populate country filter with unique countries
    function populateCountryFilter() {
      const countries = [...new Set(allMembers.map(m => m.country).filter(c => c))].sort();
      const select = document.getElementById('countryFilter');

      countries.forEach(country => {
        const option = document.createElement('option');
        option.value = country;
        option.textContent = country;
        select.appendChild(option);
      });
    }

    // Display members in table
    function displayMembers() {
      const tableHeader = document.getElementById('tableHeader');
      const tableBody = document.getElementById('tableBody');
      const emptyState = document.getElementById('emptyState');
      const directoryContent = document.getElementById('directoryContent');
      const resultsCount = document.getElementById('resultsCount');
      const visibleColumnsInfo = document.getElementById('visibleColumnsInfo');

      if (filteredMembers.length === 0) {
        directoryContent.style.display = 'none';
        emptyState.style.display = 'block';
        resultsCount.textContent = t('noMembersFound');
        return;
      }

      emptyState.style.display = 'none';
      directoryContent.style.display = 'block';

      // Get columns that have visible data
      const visibleColumns = getVisibleColumns();

      // Update stats
      const count = filteredMembers.length;
      resultsCount.textContent = `${count} member${count !== 1 ? 's' : ''}`;
      visibleColumnsInfo.textContent = `${visibleColumns.length} columns`;

      // Build table header
      tableHeader.innerHTML = `
        <tr>
          ${visibleColumns.map(col => `
            <th
              data-column="${col.key}"
              onclick="handleSort('${col.key}')"
              class="${sortColumn === col.key ? (sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}"
            >
              ${col.label}
            </th>
          `).join('')}
        </tr>
      `;

      // Sort members
      const sortedMembers = [...filteredMembers].sort((a, b) => {
        let aVal = a[sortColumn] || '';
        let bVal = b[sortColumn] || '';

        // Handle arrays
        if (Array.isArray(aVal)) aVal = aVal.join(', ');
        if (Array.isArray(bVal)) bVal = bVal.join(', ');

        // String comparison
        aVal = String(aVal).toLowerCase();
        bVal = String(bVal).toLowerCase();

        if (sortDirection === 'asc') {
          return aVal.localeCompare(bVal);
        } else {
          return bVal.localeCompare(aVal);
        }
      });

      // Build table body
      tableBody.innerHTML = sortedMembers.map(member => {
        const visibleFields = member.directory_visible_fields || {};

        return `
          <tr>
            ${visibleColumns.map(col => {
              // Check if this field is visible for this member
              if (!col.alwaysVisible && !visibleFields[col.visibilityField]) {
                return `<td style="color: var(--admin-text-muted, #9ca3af);">‚Äî</td>`;
              }

              return `<td>${renderCell(member, col.key)}</td>`;
            }).join('')}
          </tr>
        `;
      }).join('');
    }

    // Render a single cell based on column type
    function renderCell(member, key) {
      const value = member[key];

      switch (key) {
        case 'full_name':
          const initials = getInitials(member.full_name);
          return `
            <div class="member-name-cell">
              <div class="member-avatar" title="${escapeHtml(member.full_name)}">${initials}</div>
              <span class="member-name-text">${escapeHtml(member.full_name)}</span>
            </div>
          `;

        case 'contact_email':
          if (!value) return '‚Äî';
          return `<a href="mailto:${escapeHtml(value)}" class="email-link">${escapeHtml(value)}</a>`;

        case 'bio':
          if (!value) return '‚Äî';
          return `<div class="bio-cell" title="${escapeHtml(value)}">${escapeHtml(truncate(value, 100))}</div>`;

        case 'research_areas':
          if (!value || !Array.isArray(value) || value.length === 0) return '‚Äî';
          return `
            <div class="tags-container">
              ${value.slice(0, 3).map(area => `<span class="tag">${escapeHtml(area)}</span>`).join('')}
              ${value.length > 3 ? `<span class="tag" style="background: var(--admin-gray-200);">+${value.length - 3}</span>` : ''}
            </div>
          `;

        case 'conference_history':
          if (!value || !Array.isArray(value) || value.length === 0) return '‚Äî';
          return `
            <div class="tags-container">
              ${value.slice(0, 3).map(conf => `<span class="tag conference">ICSR ${conf.year}</span>`).join('')}
              ${value.length > 3 ? `<span class="tag">+${value.length - 3}</span>` : ''}
            </div>
          `;

        default:
          if (!value) return '‚Äî';
          return escapeHtml(String(value));
      }
    }

    // Handle column sort
    function handleSort(column) {
      if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortColumn = column;
        sortDirection = 'asc';
      }
      displayMembers();
    }

    // Apply filters
    function applyFilters() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
      const country = document.getElementById('countryFilter').value;
      const conference = document.getElementById('conferenceFilter').value;

      filteredMembers = allMembers.filter(member => {
        // Search filter
        if (searchTerm) {
          const searchableText = [
            member.full_name,
            member.organization,
            member.bio,
            member.position,
            ...(Array.isArray(member.research_areas) ? member.research_areas : [])
          ].join(' ').toLowerCase();

          if (!searchableText.includes(searchTerm)) {
            return false;
          }
        }

        // Country filter
        if (country && member.country !== country) {
          return false;
        }

        // Conference filter
        if (conference) {
          const conferences = member.conference_history || [];
          const hasConference = conferences.some(c => c.year === parseInt(conference));
          if (!hasConference) {
            return false;
          }
        }

        return true;
      });

      displayMembers();
    }

    // Debounced search
    function handleSearchDebounced() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(applyFilters, 300);
    }

    // Clear all filters
    function clearFilters() {
      document.getElementById('searchInput').value = '';
      document.getElementById('countryFilter').value = '';
      document.getElementById('conferenceFilter').value = '';
      applyFilters();
    }

    // Utility functions
    function getInitials(name) {
      if (!name) return '?';
      const parts = name.trim().split(' ');
      if (parts.length === 1) return parts[0][0].toUpperCase();
      return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function truncate(text, maxLength) {
      if (!text || text.length <= maxLength) return text;
      return text.substring(0, maxLength).trim() + '...';
    }

    // Load directory on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadDirectory();

      // Hide CTA if user is logged in
      if (MemberAuth.isAuthenticated()) {
        document.getElementById('ctaSection').style.display = 'none';
      }
    });
  </script>
</body>
</html>
