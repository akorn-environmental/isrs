<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Verifying your login to ISRS">
  <title>Verifying Login - ISRS</title>
  <link rel="icon" type="image/png" href="/images/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Marcellus&family=PT+Serif:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">

  <script src="/js/theme.js"></script>
  <script src="/js/analytics.js"></script>
  <script src="/js/components.js?v=2.1.0"></script>
  <script src="/js/member-auth.js"></script>
</head>
<body>
  <header id="site-header"></header>

  <script>
    // Load header with language switcher
    loadHeader();
  </script>

  <main id="main-content">
    <div class="container" style="max-width: 600px; margin: 4rem auto; padding: 2rem;">

      <!-- Loading State -->
      <div id="loadingState" style="text-align: center;">
        <div class="spinner" style="margin: 2rem auto 1rem; width: 60px; height: 60px; border: 4px solid var(--border-color); border-top-color: var(--primary-blue); border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <h1 id="verifyingHeading" style="color: var(--text-light); margin-bottom: 0.5rem;"></h1>
        <p id="verifyingText" style="color: var(--text-light);"></p>
      </div>

      <!-- Error State -->
      <div id="errorState" style="display: none; text-align: center;">
        <div style="font-size: 4rem; color: #c00; margin-bottom: 1rem;">✗</div>
        <h1 id="errorHeading" style="color: #c00; margin-bottom: 1rem;"></h1>
        <p id="errorMessage" style="font-size: 1.1rem; line-height: 1.6; margin-bottom: 2rem; color: var(--text-color);"></p>
        <div style="padding: 1.5rem; background: #fef8e7; border: 1px solid #f4d03f; border-radius: 4px; margin-bottom: 2rem;">
          <p id="troubleshootingText" style="margin: 0; color: var(--text-color);"></p>
        </div>
        <p>
          <a href="/member/login.html" id="requestNewLinkBtn" class="btn btn-primary"></a>
        </p>
        <p style="margin-top: 1rem;">
          <a href="/" id="returnHomeBtn" class="btn btn-secondary"></a>
        </p>
      </div>

    </div>
  </main>

  <footer id="site-footer"></footer>

  <script>
    // Load footer
    loadFooter();

    // Update page content with translations
    function updateVerifyPageText() {
      document.getElementById('verifyingHeading').textContent = t('verifyingLogin');
      document.getElementById('verifyingText').textContent = t('verifyingLoginText');
      document.getElementById('errorHeading').textContent = t('loginFailed');
      document.getElementById('requestNewLinkBtn').textContent = t('requestNewLoginLink');
      document.getElementById('returnHomeBtn').textContent = t('returnToHome');

      // Troubleshooting section needs HTML
      document.getElementById('troubleshootingText').innerHTML =
        '<strong>' + t('troubleshooting') + '</strong><br>' +
        '• ' + t('linksExpire') + '<br>' +
        '• ' + t('oneTimeUse') + '<br>' +
        '• ' + t('useLatestLink');

      // Update page title
      document.title = t('verifyingLogin') + ' - ISRS';
    }

    // Initial text update
    updateVerifyPageText();

    // Listen for language changes
    window.addEventListener('languageChanged', updateVerifyPageText);
  </script>

  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>

  <script>
    const loadingState = document.getElementById('loadingState');
    const errorState = document.getElementById('errorState');
    const errorMessage = document.getElementById('errorMessage');

    // Constants for smart redirect logic
    const PROFILE_UPDATE_PROMPT_KEY = 'isrs_last_profile_update_prompt';
    const PROFILE_UPDATE_INTERVAL_DAYS = 30;
    const MINIMUM_COMPLETION_SCORE = 50;

    /**
     * Check if user should be prompted to update their profile
     * Returns true if 30+ days since last prompt
     * On first login (no timestamp), sets timestamp and skips prompt
     */
    function shouldPromptForProfileUpdate() {
      const lastPrompt = localStorage.getItem(PROFILE_UPDATE_PROMPT_KEY);
      if (!lastPrompt) {
        // First time - set the timestamp but DON'T prompt yet
        // User will be prompted after 30 days from now
        markProfileUpdatePrompted();
        return false;
      }

      const lastPromptDate = new Date(parseInt(lastPrompt));
      const now = new Date();
      const daysSincePrompt = (now - lastPromptDate) / (1000 * 60 * 60 * 24);

      return daysSincePrompt >= PROFILE_UPDATE_INTERVAL_DAYS;
    }

    /**
     * Mark that we prompted the user to update their profile
     */
    function markProfileUpdatePrompted() {
      localStorage.setItem(PROFILE_UPDATE_PROMPT_KEY, Date.now().toString());
    }

    /**
     * Determine the correct portal destination based on user role
     */
    function getPortalDestination(profile) {
      const role = profile.role || 'member';

      // Admin and board members go to admin portal
      if (role === 'admin' || role === 'board_member') {
        return '/admin/index.html';
      }

      // All others go to member portal
      return '/member/index.html';
    }

    async function verifyLogin() {
      // Get token from URL
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');

      if (!token) {
        showError(t('noTokenProvided'));
        return;
      }

      try {
        // Step 1: Verify the magic link token
        console.log('Verifying magic link token...');
        const verifyResponse = await MemberAuth.verifyMagicLink(token);

        if (!verifyResponse.success) {
          throw new Error(verifyResponse.error || 'Failed to verify login link');
        }

        console.log('Magic link verified successfully');

        // Step 2: Get profile to check completion and role
        console.log('Fetching user profile...');
        const profileResponse = await MemberAuth.getProfile();

        if (!profileResponse || !profileResponse.email) {
          throw new Error('Failed to load profile');
        }

        // Step 3: Smart redirect logic
        const requiresSetup = profileResponse.requiresFirstTimeSetup;
        const completionScore = profileResponse.profile_completion_score || 0;
        const hasCompletedBasicInfo = completionScore >= MINIMUM_COMPLETION_SCORE;

        console.log('Profile completion score:', completionScore);
        console.log('Has completed basic info:', hasCompletedBasicInfo);
        console.log('Setup required flag:', requiresSetup);

        // Check if there was a specific redirect URL requested
        const explicitRedirect = urlParams.get('redirect');
        if (explicitRedirect) {
          // User was trying to access a specific page, honor that request
          console.log('Redirecting to explicitly requested URL:', explicitRedirect);
          window.location.href = explicitRedirect;
          return;
        }

        if (requiresSetup || !hasCompletedBasicInfo) {
          // First-time user or incomplete profile - go to welcome/profile setup
          console.log('Redirecting to profile setup (incomplete profile)');
          window.location.href = '/member/welcome.html';
        } else {
          // User has completed basic profile (50%+ completion)
          // Check if we should prompt for profile update
          if (shouldPromptForProfileUpdate()) {
            console.log('Prompting for profile update (30+ days since last prompt)');
            markProfileUpdatePrompted();
            // Redirect to profile page with a message to review/update
            window.location.href = '/member/profile.html?review=true';
          } else {
            // Redirect to appropriate portal based on role
            const destination = getPortalDestination(profileResponse);
            console.log('Redirecting to portal:', destination);
            window.location.href = destination;
          }
        }

      } catch (error) {
        console.error('Verification error:', error);
        showError(error.message || t('verificationError'));
      }
    }

    function showError(message) {
      errorMessage.textContent = message;
      loadingState.style.display = 'none';
      errorState.style.display = 'block';
    }

    // Auto-verify when page loads
    document.addEventListener('DOMContentLoaded', verifyLogin);
  </script>
</body>
</html>
