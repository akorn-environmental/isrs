<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Verifying your login to ISRS">
  <title>Verifying Login - ISRS</title>
  <link rel="icon" type="image/png" href="/images/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Marcellus&family=PT+Serif:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">

  <script src="/js/theme.js"></script>
  <script src="/js/analytics.js"></script>
  <script src="/js/components.js"></script>
  <script src="/js/member-auth.js"></script>
</head>
<body>
  <header id="site-header"></header>

  <script>
    // Load header with language switcher
    loadHeader();
  </script>

  <main id="main-content">
    <div class="container" style="max-width: 600px; margin: 4rem auto; padding: 2rem;">

      <!-- Loading State -->
      <div id="loadingState" style="text-align: center;">
        <div class="spinner" style="margin: 2rem auto 1rem; width: 60px; height: 60px; border: 4px solid var(--border-color); border-top-color: var(--primary-blue); border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <h1 id="verifyingHeading" style="color: var(--text-light); margin-bottom: 0.5rem;"></h1>
        <p id="verifyingText" style="color: var(--text-light);"></p>
      </div>

      <!-- Error State -->
      <div id="errorState" style="display: none; text-align: center;">
        <div style="font-size: 4rem; color: #c00; margin-bottom: 1rem;">✗</div>
        <h1 id="errorHeading" style="color: #c00; margin-bottom: 1rem;"></h1>
        <p id="errorMessage" style="font-size: 1.1rem; line-height: 1.6; margin-bottom: 2rem; color: var(--text-color);"></p>
        <div style="padding: 1.5rem; background: #fef8e7; border: 1px solid #f4d03f; border-radius: 4px; margin-bottom: 2rem;">
          <p id="troubleshootingText" style="margin: 0; color: var(--text-color);"></p>
        </div>
        <p>
          <a href="/member/login.html" id="requestNewLinkBtn" class="btn btn-primary"></a>
        </p>
        <p style="margin-top: 1rem;">
          <a href="/" id="returnHomeBtn" class="btn btn-secondary"></a>
        </p>
      </div>

    </div>
  </main>

  <footer id="site-footer"></footer>

  <script>
    // Load footer
    loadFooter();

    // Update page content with translations
    function updateVerifyPageText() {
      document.getElementById('verifyingHeading').textContent = t('verifyingLogin');
      document.getElementById('verifyingText').textContent = t('verifyingLoginText');
      document.getElementById('errorHeading').textContent = t('loginFailed');
      document.getElementById('requestNewLinkBtn').textContent = t('requestNewLoginLink');
      document.getElementById('returnHomeBtn').textContent = t('returnToHome');

      // Troubleshooting section needs HTML
      document.getElementById('troubleshootingText').innerHTML =
        '<strong>' + t('troubleshooting') + '</strong><br>' +
        '• ' + t('linksExpire') + '<br>' +
        '• ' + t('oneTimeUse') + '<br>' +
        '• ' + t('useLatestLink');

      // Update page title
      document.title = t('verifyingLogin') + ' - ISRS';
    }

    // Initial text update
    updateVerifyPageText();

    // Listen for language changes
    window.addEventListener('languageChanged', updateVerifyPageText);
  </script>

  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>

  <script>
    const loadingState = document.getElementById('loadingState');
    const errorState = document.getElementById('errorState');
    const errorMessage = document.getElementById('errorMessage');

    async function verifyLogin() {
      // Get token from URL
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');

      if (!token) {
        showError(t('noTokenProvided'));
        return;
      }

      try {
        // Step 1: Verify the magic link token
        console.log('Verifying magic link token...');
        const verifyResponse = await MemberAuth.verifyMagicLink(token);

        if (!verifyResponse.success) {
          throw new Error(verifyResponse.error || 'Failed to verify login link');
        }

        console.log('Magic link verified successfully');

        // Step 2: Get profile to check if first-time setup is needed
        console.log('Fetching user profile...');
        const profileResponse = await MemberAuth.getProfile();

        if (!profileResponse || !profileResponse.email) {
          throw new Error('Failed to load profile');
        }

        // Step 3: Redirect based on setup status
        // Note: Backend returns profile data directly, not wrapped in {success, data}
        const requiresSetup = profileResponse.requiresFirstTimeSetup;

        console.log('Setup required:', requiresSetup);

        if (requiresSetup) {
          // First-time user or incomplete profile - go to welcome page
          window.location.href = '/member/welcome.html';
        } else {
          // Returning user with complete profile - go to profile page
          // Check if there was a redirect URL specified
          const redirectUrl = urlParams.get('redirect') || '/member/profile.html';
          window.location.href = redirectUrl;
        }

      } catch (error) {
        console.error('Verification error:', error);
        showError(error.message || t('verificationError'));
      }
    }

    function showError(message) {
      errorMessage.textContent = message;
      loadingState.style.display = 'none';
      errorState.style.display = 'block';
    }

    // Auto-verify when page loads
    document.addEventListener('DOMContentLoaded', verifyLogin);
  </script>
</body>
</html>
