<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Email Parser - ISRS Admin</title>
  <link rel="icon" type="image/png" href="/images/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Marcellus&family=PT+Serif:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="/css/admin-layout.css">
  <link rel="stylesheet" href="/css/admin-unified.css">
  <script src="/js/errorReporter.js"></script>
  <style>
    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--admin-space-xl);
    }
    @media (max-width: 1024px) {
      .two-column {
        grid-template-columns: 1fr;
      }
    }
    .parse-form textarea {
      min-height: 250px;
      font-family: monospace;
      font-size: var(--admin-text-sm);
    }
    .confidence-badge {
      display: inline-block;
      padding: 0.125rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.7rem;
      font-weight: 600;
    }
    .confidence-high {
      background: var(--admin-success-bg);
      color: var(--admin-success-text);
    }
    .confidence-medium {
      background: var(--admin-warning-bg);
      color: var(--admin-warning-text);
    }
    .confidence-low {
      background: var(--admin-danger-bg);
      color: var(--admin-danger-text);
    }
    .contact-card {
      background: var(--admin-gray-50);
      padding: var(--admin-space-md);
      border-radius: var(--admin-radius-md);
      margin-bottom: var(--admin-space-sm);
    }
    .contact-card h4 {
      margin: 0 0 var(--admin-space-xs) 0;
      font-size: var(--admin-text-md);
    }
    .contact-info {
      font-size: var(--admin-text-sm);
      color: var(--admin-gray-600);
    }
    .action-item {
      background: var(--admin-info-bg);
      border-left: 3px solid var(--admin-info);
      padding: var(--admin-space-md);
      margin-bottom: var(--admin-space-sm);
      border-radius: var(--admin-radius-sm);
    }
    .flag-item {
      background: var(--admin-danger-bg);
      border-left: 3px solid var(--admin-danger);
      padding: var(--admin-space-sm) var(--admin-space-md);
      margin-bottom: var(--admin-space-sm);
      border-radius: var(--admin-radius-sm);
      font-size: var(--admin-text-sm);
    }
    .email-item {
      background: var(--admin-gray-50);
      padding: var(--admin-space-md);
      border-radius: var(--admin-radius-md);
      margin-bottom: var(--admin-space-md);
      cursor: pointer;
      transition: all 0.15s;
      border: 1px solid var(--admin-gray-200);
    }
    .email-item:hover {
      background: var(--admin-surface-hover);
      transform: translateY(-2px);
      box-shadow: var(--admin-shadow-sm);
    }
    .email-subject {
      font-weight: 600;
      color: var(--admin-text);
      margin-bottom: var(--admin-space-xs);
    }
    .email-from {
      font-size: var(--admin-text-sm);
      color: var(--admin-gray-600);
    }
    .review-status {
      display: inline-block;
      padding: 0.125rem 0.5rem;
      border-radius: var(--admin-radius-sm);
      font-size: 0.7rem;
      font-weight: 600;
      margin-top: var(--admin-space-sm);
    }
    .status-approved {
      background: var(--admin-success-bg);
      color: var(--admin-success-text);
    }
    .status-pending {
      background: var(--admin-warning-bg);
      color: var(--admin-warning-text);
    }
    .result-section {
      margin-top: var(--admin-space-lg);
      padding-top: var(--admin-space-lg);
      border-top: 1px solid var(--admin-gray-200);
    }
    .result-section:first-child {
      margin-top: 0;
      padding-top: 0;
      border-top: none;
    }
    .result-section h3 {
      margin: 0 0 var(--admin-space-md) 0;
      font-size: var(--admin-text-md);
    }
    .parsed-emails-list {
      max-height: 500px;
      overflow-y: auto;
    }
    .empty-state {
      text-align: center;
      padding: var(--admin-space-2xl);
      color: var(--admin-gray-500);
    }
    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: var(--admin-space-md);
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--admin-gray-200);
      border-top-color: var(--admin-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto var(--admin-space-md);
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="admin-page">
  <div class="admin-content-padded" style="max-width: 1400px; margin: 0 auto;">
    <!-- Page Header -->
    <div class="admin-page-header" style="background: transparent; border: none; padding-left: 0;">
      <h1>Email Parser</h1>
      <p class="admin-text-muted">Automatically extract contacts, action items, and fundraising signals from emails</p>
    </div>

    <!-- Gmail Integration Status -->
    <div class="admin-card" style="margin-bottom: var(--admin-space-lg);" id="gmailStatus">
      <div class="admin-card-header">
        <h2 style="margin: 0;">Gmail Integration</h2>
      </div>
      <div class="admin-card-body">
        <div id="gmailConnected" style="display: none;">
          <div style="display: flex; align-items: center; gap: var(--admin-space-md); margin-bottom: var(--admin-space-md);">
            <span style="color: var(--admin-success-text); font-size: 1.5rem;">‚úì</span>
            <div style="flex: 1;">
              <strong>Connected to Gmail</strong>
              <div style="font-size: var(--admin-text-sm); color: var(--admin-gray-600);" id="gmailAccount"></div>
            </div>
          </div>
          <div style="display: flex; gap: var(--admin-space-sm); flex-wrap: wrap;">
            <button class="admin-btn admin-btn-secondary admin-btn-sm" onclick="checkPollerStatus()">
              <span style="margin-right: 0.25rem;">‚Ñπ</span> Check Status
            </button>
            <button class="admin-btn admin-btn-success admin-btn-sm" onclick="startPoller()" id="startPollerBtn">
              <span style="margin-right: 0.25rem;">‚ñ∂</span> Start Auto-Polling
            </button>
            <button class="admin-btn admin-btn-warning admin-btn-sm" onclick="pausePoller()" id="pausePollerBtn" style="display: none;">
              <span style="margin-right: 0.25rem;">‚è∏</span> Pause
            </button>
            <button class="admin-btn admin-btn-danger admin-btn-sm" onclick="stopPoller()" id="stopPollerBtn" style="display: none;">
              <span style="margin-right: 0.25rem;">‚èπ</span> Stop
            </button>
            <button class="admin-btn admin-btn-primary admin-btn-sm" onclick="triggerManualPoll()">
              <span style="margin-right: 0.25rem;">‚ö°</span> Poll Now
            </button>
          </div>
          <div id="pollerStatus" style="margin-top: var(--admin-space-md); padding: var(--admin-space-sm); background: var(--admin-gray-50); border-radius: var(--admin-radius-sm); font-size: var(--admin-text-sm); display: none;"></div>
        </div>
        <div id="gmailDisconnected">
          <p style="margin: 0 0 var(--admin-space-md) 0; color: var(--admin-gray-600);">
            Connect your Gmail account to automatically import and parse emails with the "ISRS-Leads" label.
          </p>
          <button class="admin-btn admin-btn-primary" onclick="connectGmail()">
            <span style="margin-right: 0.25rem;">üìß</span> Connect Gmail Account
          </button>
        </div>
      </div>
    </div>

    <div class="two-column">
      <!-- Left: Parse New Email -->
      <div>
        <div class="admin-card">
          <div class="admin-card-header">
            <h2 style="margin: 0;">Parse New Email</h2>
          </div>
          <div class="admin-card-body">
            <form id="parseForm" class="parse-form" onsubmit="parseEmail(event)">
              <div class="admin-form-group">
                <label class="admin-label">Subject</label>
                <input type="text" id="subject" class="admin-input" placeholder="Email subject line" required>
              </div>
              <div class="admin-form-group">
                <label class="admin-label">From Name</label>
                <input type="text" id="fromName" class="admin-input" placeholder="Sender name">
              </div>
              <div class="admin-form-group">
                <label class="admin-label">From Email</label>
                <input type="email" id="fromEmail" class="admin-input" placeholder="sender@example.com" required>
              </div>
              <div class="admin-form-group">
                <label class="admin-label">Email Body</label>
                <textarea id="emailBody" class="admin-input" placeholder="Paste full email content here..." required></textarea>
              </div>
              <button type="submit" class="admin-btn admin-btn-primary" id="parseBtn" style="width: 100%;">
                Parse Email
              </button>
            </form>
          </div>
        </div>

        <!-- Results -->
        <div id="results" class="admin-card" style="display: none; margin-top: var(--admin-space-lg);">
          <div class="admin-card-header">
            <h2 style="margin: 0;">Parsed Results</h2>
          </div>
          <div class="admin-card-body" id="resultsContent">
            <!-- Populated dynamically -->
          </div>
        </div>
      </div>

      <!-- Right: Recent Parsed Emails -->
      <div>
        <div class="admin-card">
          <div class="admin-card-header">
            <h2 style="margin: 0;">Recently Parsed Emails</h2>
            <button class="admin-btn admin-btn-secondary admin-btn-sm" onclick="loadParsedEmails()">
              <span style="margin-right: 0.25rem;">‚Üª</span> Refresh
            </button>
          </div>
          <!-- Filters -->
          <div style="padding: var(--admin-space-md); border-bottom: 1px solid var(--admin-gray-200); background: var(--admin-gray-50);">
            <div style="display: flex; gap: var(--admin-space-sm); flex-wrap: wrap;">
              <select id="filterSource" class="admin-input" style="flex: 1; min-width: 150px;" onchange="loadParsedEmails()">
                <option value="">All Sources</option>
                <option value="gmail">Gmail</option>
                <option value="manual">Manual</option>
              </select>
              <select id="filterStatus" class="admin-input" style="flex: 1; min-width: 150px;" onchange="loadParsedEmails()">
                <option value="">All Statuses</option>
                <option value="pending">Pending</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
              </select>
              <input type="text" id="filterSearch" class="admin-input" placeholder="Search..." style="flex: 2; min-width: 200px;" onkeyup="debounceSearch()">
            </div>
          </div>
          <div class="admin-card-body" style="padding: 0;">
            <div id="loading" class="empty-state">
              <div class="loading-spinner"></div>
              <p>Loading parsed emails...</p>
            </div>
            <div id="parsedEmailsList" class="parsed-emails-list" style="display: none; padding: var(--admin-space-lg);"></div>
          </div>
        </div>

        <!-- Analytics -->
        <div class="admin-card" style="margin-top: var(--admin-space-lg);" id="analyticsCard" style="display: none;">
          <div class="admin-card-header">
            <h2 style="margin: 0;">Analytics</h2>
          </div>
          <div class="admin-card-body">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--admin-space-md);">
              <div style="text-align: center; padding: var(--admin-space-md); background: var(--admin-gray-50); border-radius: var(--admin-radius-md);">
                <div style="font-size: 2rem; font-weight: 700; color: var(--admin-primary);" id="totalEmails">0</div>
                <div style="font-size: var(--admin-text-sm); color: var(--admin-gray-600); margin-top: var(--admin-space-xs);">Total Emails</div>
              </div>
              <div style="text-align: center; padding: var(--admin-space-md); background: var(--admin-gray-50); border-radius: var(--admin-radius-md);">
                <div style="font-size: 2rem; font-weight: 700; color: var(--admin-success-text);" id="totalContacts">0</div>
                <div style="font-size: var(--admin-text-sm); color: var(--admin-gray-600); margin-top: var(--admin-space-xs);">Contacts Extracted</div>
              </div>
              <div style="text-align: center; padding: var(--admin-space-md); background: var(--admin-gray-50); border-radius: var(--admin-radius-md);">
                <div style="font-size: 2rem; font-weight: 700; color: var(--admin-warning-text);" id="avgConfidence">0%</div>
                <div style="font-size: var(--admin-text-sm); color: var(--admin-gray-600); margin-top: var(--admin-space-xs);">Avg Confidence</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/email-utils.js"></script>
  <script src="/js/admin-layout.js"></script>
  <script>
    const API_BASE = '';  // Use same-origin

    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      const sessionToken = localStorage.getItem('isrs_session_token');
      if (!sessionToken) {
        window.location.href = '/admin/';
        return;
      }

      loadAdminLayout('email-parser');
      checkGmailConnection();
      loadParsedEmails();
    });

    // Gmail Integration Functions
    async function checkGmailConnection() {
      try {
        const token = localStorage.getItem('isrs_session_token');
        const response = await fetch(`${API_BASE}/api/gmail-oauth/status`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const data = await response.json();
          if (data.connected) {
            document.getElementById('gmailConnected').style.display = 'block';
            document.getElementById('gmailDisconnected').style.display = 'none';
            document.getElementById('gmailAccount').textContent = data.email || 'Connected';
            checkPollerStatus();
          } else {
            document.getElementById('gmailConnected').style.display = 'none';
            document.getElementById('gmailDisconnected').style.display = 'block';
          }
        }
      } catch (error) {
        console.error('Error checking Gmail connection:', error);
      }
    }

    async function connectGmail() {
      try {
        const token = localStorage.getItem('isrs_session_token');
        const response = await fetch(`${API_BASE}/api/gmail-oauth/authorize`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const data = await response.json();
          if (data.authorizeUrl) {
            window.location.href = data.authorizeUrl;
          }
        } else {
          alert('Failed to initiate Gmail connection');
        }
      } catch (error) {
        console.error('Error connecting Gmail:', error);
        alert('Error connecting to Gmail');
      }
    }

    async function checkPollerStatus() {
      try {
        const token = localStorage.getItem('isrs_session_token');
        const response = await fetch(`${API_BASE}/api/email-parsing/gmail-poller/status`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const data = await response.json();
          updatePollerUI(data);
        }
      } catch (error) {
        console.error('Error checking poller status:', error);
      }
    }

    function updatePollerUI(status) {
      const statusEl = document.getElementById('pollerStatus');
      const startBtn = document.getElementById('startPollerBtn');
      const pauseBtn = document.getElementById('pausePollerBtn');
      const stopBtn = document.getElementById('stopPollerBtn');

      if (status.isRunning) {
        startBtn.style.display = 'none';
        pauseBtn.style.display = 'inline-block';
        stopBtn.style.display = 'inline-block';
        statusEl.style.display = 'block';
        statusEl.innerHTML = `
          <strong>Status:</strong> ${status.isPaused ? 'Paused' : 'Running'}<br>
          <strong>Last Poll:</strong> ${status.lastPoll ? new Date(status.lastPoll).toLocaleString() : 'Never'}<br>
          <strong>Emails Processed:</strong> ${status.emailsProcessed || 0}
        `;
      } else {
        startBtn.style.display = 'inline-block';
        pauseBtn.style.display = 'none';
        stopBtn.style.display = 'none';
        statusEl.style.display = 'block';
        statusEl.innerHTML = '<strong>Status:</strong> Not Running';
      }
    }

    async function startPoller() {
      try {
        const token = localStorage.getItem('isrs_session_token');
        const response = await fetch(`${API_BASE}/api/email-parsing/gmail-poller/start`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const data = await response.json();
          alert(data.message || 'Gmail poller started');
          checkPollerStatus();
        } else {
          alert('Failed to start poller');
        }
      } catch (error) {
        console.error('Error starting poller:', error);
        alert('Error starting poller');
      }
    }

    async function pausePoller() {
      try {
        const token = localStorage.getItem('isrs_session_token');
        const response = await fetch(`${API_BASE}/api/email-parsing/gmail-poller/pause`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          checkPollerStatus();
        }
      } catch (error) {
        console.error('Error pausing poller:', error);
      }
    }

    async function stopPoller() {
      try {
        const token = localStorage.getItem('isrs_session_token');
        const response = await fetch(`${API_BASE}/api/email-parsing/gmail-poller/stop`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          checkPollerStatus();
        }
      } catch (error) {
        console.error('Error stopping poller:', error);
      }
    }

    async function triggerManualPoll() {
      const btn = event.target.closest('button');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span style="margin-right: 0.25rem;">‚è≥</span> Polling...';

      try {
        const token = localStorage.getItem('isrs_session_token');
        const response = await fetch(`${API_BASE}/api/email-parsing/gmail-poller/trigger`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const data = await response.json();
          alert(data.message || 'Poll completed');
          loadParsedEmails();
          checkPollerStatus();
        } else {
          alert('Failed to trigger poll');
        }
      } catch (error) {
        console.error('Error triggering poll:', error);
        alert('Error triggering poll');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    async function parseEmail(event) {
      event.preventDefault();

      const subject = document.getElementById('subject').value;
      const fromName = document.getElementById('fromName').value;
      const fromEmail = document.getElementById('fromEmail').value;
      const emailBody = document.getElementById('emailBody').value;

      const btn = document.getElementById('parseBtn');
      btn.disabled = true;
      btn.textContent = 'Parsing...';
      document.getElementById('results').style.display = 'none';

      try {
        const token = localStorage.getItem('isrs_session_token');
        const response = await fetch(`${API_BASE}/api/email-parsing/parse`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            subject,
            fromName,
            fromEmail,
            emailBody,
            receivedDate: new Date().toISOString()
          })
        });

        if (!response.ok) {
          if (response.status === 404) {
            throw new Error('Email parsing API not available. This feature requires backend configuration.');
          }
          throw new Error('Failed to parse email');
        }

        const data = await response.json();

        if (data.success) {
          displayResults(data);
          loadParsedEmails();
          document.getElementById('parseForm').reset();
        } else {
          alert('Error: ' + (data.error || 'Failed to parse email'));
        }
      } catch (error) {
        console.error('Parse error:', error);
        alert(error.message || 'Failed to parse email. Please try again.');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Parse Email';
      }
    }

    function displayResults(data) {
      const { parsed, overallConfidence } = data;

      let html = `
        <div class="result-section">
          <div style="margin-bottom: var(--admin-space-md);">
            <strong>Overall Confidence:</strong> ${getConfidenceBadge(overallConfidence)}
            <span style="margin-left: var(--admin-space-md); color: var(--admin-gray-600);">
              Review Status: ${data.reviewStatus || 'pending'}
            </span>
          </div>
        </div>
      `;

      if (parsed.summary) {
        html += `
          <div class="result-section">
            <h3>Summary</h3>
            <p style="margin: 0; color: var(--admin-gray-700);">${escapeHtml(parsed.summary)}</p>
          </div>
        `;
      }

      if (parsed.contacts && parsed.contacts.length > 0) {
        html += `
          <div class="result-section">
            <h3>Contacts Extracted (${parsed.contacts.length})</h3>
            ${parsed.contacts.map(c => `
              <div class="contact-card">
                <h4>${escapeHtml(c.name)} ${getConfidenceBadge(c.confidence)}</h4>
                <div class="contact-info">
                  ${c.email ? `<div>Email: ${escapeHtml(c.email)}</div>` : ''}
                  ${c.organization ? `<div>Organization: ${escapeHtml(c.organization)}</div>` : ''}
                  ${c.title ? `<div>Title: ${escapeHtml(c.title)}</div>` : ''}
                  ${c.phone ? `<div>Phone: ${escapeHtml(c.phone)}</div>` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        `;
      }

      if (parsed.action_items && parsed.action_items.length > 0) {
        html += `
          <div class="result-section">
            <h3>Action Items (${parsed.action_items.length})</h3>
            ${parsed.action_items.map(a => `
              <div class="action-item">
                <strong>${escapeHtml(a.item)}</strong>
                <div style="font-size: var(--admin-text-sm); margin-top: var(--admin-space-xs); color: var(--admin-gray-600);">
                  ${a.owner ? `Owner: ${escapeHtml(a.owner)} | ` : ''}
                  ${a.deadline ? `Deadline: ${escapeHtml(a.deadline)} | ` : ''}
                  Priority: ${a.priority || 'normal'} ${getConfidenceBadge(a.confidence)}
                </div>
              </div>
            `).join('')}
          </div>
        `;
      }

      if (parsed.fundraising && parsed.fundraising.signals && parsed.fundraising.signals.length > 0) {
        html += `
          <div class="result-section">
            <h3>Fundraising Signals</h3>
            <ul style="margin: 0; padding-left: var(--admin-space-lg);">
              ${parsed.fundraising.signals.map(s => `<li>${escapeHtml(s)}</li>`).join('')}
            </ul>
          </div>
        `;
      }

      if (parsed.flags && parsed.flags.length > 0) {
        html += `
          <div class="result-section">
            <h3>Flags</h3>
            ${parsed.flags.map(f => `<div class="flag-item">${escapeHtml(f)}</div>`).join('')}
          </div>
        `;
      }

      if (parsed.recommended_next_steps && parsed.recommended_next_steps.length > 0) {
        html += `
          <div class="result-section">
            <h3>Recommended Next Steps</h3>
            <ol style="margin: 0; padding-left: var(--admin-space-lg);">
              ${parsed.recommended_next_steps.map(s => `<li>${escapeHtml(s)}</li>`).join('')}
            </ol>
          </div>
        `;
      }

      document.getElementById('resultsContent').innerHTML = html;
      document.getElementById('results').style.display = 'block';
    }

    function getConfidenceBadge(confidence) {
      if (!confidence && confidence !== 0) return '';
      const level = confidence >= 70 ? 'high' : confidence >= 50 ? 'medium' : 'low';
      return `<span class="confidence-badge confidence-${level}">${confidence}%</span>`;
    }

    // Debounce search input
    let searchTimeout;
    function debounceSearch() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        loadParsedEmails();
      }, 500);
    }

    // Filter emails based on UI selections
    function filterEmails(emails) {
      const sourceFilter = document.getElementById('filterSource')?.value || '';
      const statusFilter = document.getElementById('filterStatus')?.value || '';
      const searchFilter = document.getElementById('filterSearch')?.value.toLowerCase() || '';

      return emails.filter(email => {
        // Source filter
        if (sourceFilter && email.source !== sourceFilter) {
          return false;
        }

        // Status filter
        if (statusFilter && email.review_status !== statusFilter) {
          return false;
        }

        // Search filter (search in subject, from_name, from_email)
        if (searchFilter) {
          const searchableText = [
            email.subject || '',
            email.from_name || '',
            email.from_email || '',
            email.parsed_data?.summary || ''
          ].join(' ').toLowerCase();

          if (!searchableText.includes(searchFilter)) {
            return false;
          }
        }

        return true;
      });
    }

    // Calculate analytics from emails
    function calculateAnalytics(emails) {
      const totalEmails = emails.length;
      const totalContacts = emails.reduce((sum, email) => {
        return sum + (email.parsed_data?.contacts?.length || 0);
      }, 0);

      const confidenceScores = emails
        .map(e => e.overall_confidence)
        .filter(c => c !== null && c !== undefined);

      const avgConfidence = confidenceScores.length > 0
        ? Math.round(confidenceScores.reduce((a, b) => a + b, 0) / confidenceScores.length)
        : 0;

      return { totalEmails, totalContacts, avgConfidence };
    }

    // Update analytics display
    function updateAnalytics(emails) {
      const analytics = calculateAnalytics(emails);

      const totalEmailsEl = document.getElementById('totalEmails');
      const totalContactsEl = document.getElementById('totalContacts');
      const avgConfidenceEl = document.getElementById('avgConfidence');

      if (totalEmailsEl) totalEmailsEl.textContent = analytics.totalEmails;
      if (totalContactsEl) totalContactsEl.textContent = analytics.totalContacts;
      if (avgConfidenceEl) avgConfidenceEl.textContent = `${analytics.avgConfidence}%`;

      const analyticsCard = document.getElementById('analyticsCard');
      if (analyticsCard && analytics.totalEmails > 0) {
        analyticsCard.style.display = 'block';
      }
    }

    async function loadParsedEmails() {
      const loadingEl = document.getElementById('loading');
      const listEl = document.getElementById('parsedEmailsList');

      loadingEl.style.display = 'block';
      listEl.style.display = 'none';

      try {
        const token = localStorage.getItem('isrs_session_token');
        const response = await fetch(`${API_BASE}/api/email-parsing`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          if (response.status === 404) {
            displayParsedEmails([]);
            return;
          }
          throw new Error('Failed to load emails');
        }

        const data = await response.json();

        if (data.success) {
          const allEmails = data.emails || [];
          const filteredEmails = filterEmails(allEmails);
          updateAnalytics(allEmails);
          displayParsedEmails(filteredEmails);
        } else {
          displayParsedEmails([]);
        }
      } catch (error) {
        console.error('Load error:', error);
        displayParsedEmails([]);
      }
    }

    function displayParsedEmails(emails) {
      const loadingEl = document.getElementById('loading');
      const listEl = document.getElementById('parsedEmailsList');

      loadingEl.style.display = 'none';
      listEl.style.display = 'block';

      if (!emails || emails.length === 0) {
        listEl.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìß</div>
            <h3 style="margin: 0 0 var(--admin-space-sm) 0;">No Parsed Emails Yet</h3>
            <p style="margin: 0;">Parse an email using the form to see results here.</p>
          </div>
        `;
        return;
      }

      listEl.innerHTML = emails.map(email => `
        <div class="email-item" onclick="viewEmail('${email.id}')">
          <div class="email-subject">${escapeHtml(email.subject || '(No subject)')}</div>
          <div class="email-from">From: ${escapeHtml(email.from_name || email.from_email || 'Unknown')}</div>
          <div>
            <span class="review-status status-${email.review_status || 'pending'}">
              ${email.review_status || 'pending'}
            </span>
            ${email.overall_confidence ? `<span class="confidence-badge confidence-${email.overall_confidence >= 70 ? 'high' : email.overall_confidence >= 50 ? 'medium' : 'low'}" style="margin-left: var(--admin-space-sm);">${email.overall_confidence}%</span>` : ''}
          </div>
        </div>
      `).join('');
    }

    async function viewEmail(id) {
      try {
        const token = localStorage.getItem('isrs_session_token');
        const response = await fetch(`${API_BASE}/api/email-parsing/${id}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          throw new Error('Failed to load email details');
        }

        const data = await response.json();

        if (data.success) {
          showEmailModal(data.email);
        } else {
          alert('Failed to load email details');
        }
      } catch (error) {
        console.error('Error loading email:', error);
        alert('Error loading email details');
      }
    }

    function showEmailModal(email) {
      const parsed = email.parsed_data || {};

      let modalHtml = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;" onclick="closeEmailModal(event)">
          <div style="background: white; border-radius: 8px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
            <div style="padding: 24px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: between; align-items: center;">
              <div style="flex: 1;">
                <h2 style="margin: 0 0 8px 0; font-size: 20px;">${escapeHtml(email.subject || '(No Subject)')}</h2>
                <div style="font-size: 14px; color: #666;">
                  <strong>From:</strong> ${escapeHtml(email.from_name || '')} &lt;${escapeHtml(email.from_email || '')}&gt;<br>
                  <strong>Date:</strong> ${email.email_date ? new Date(email.email_date).toLocaleString() : 'Unknown'}<br>
                  <strong>Source:</strong> ${email.source || 'manual'} |
                  <strong>Status:</strong> <span class="review-status status-${email.review_status || 'pending'}">${email.review_status || 'pending'}</span>
                </div>
              </div>
              <button onclick="closeEmailModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; padding: 8px; color: #666;">&times;</button>
            </div>

            <div style="padding: 24px;">
              ${parsed.summary ? `
                <div style="margin-bottom: 24px; padding: 16px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #2c5f2d;">
                  <h3 style="margin: 0 0 8px 0; font-size: 16px;">Summary</h3>
                  <p style="margin: 0; line-height: 1.6;">${escapeHtml(parsed.summary)}</p>
                </div>
              ` : ''}

              ${parsed.contacts && parsed.contacts.length > 0 ? `
                <div style="margin-bottom: 24px;">
                  <h3 style="margin: 0 0 12px 0; font-size: 16px;">Contacts Extracted (${parsed.contacts.length})</h3>
                  <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px;">
                    ${parsed.contacts.map(c => `
                      <div style="padding: 12px; background: #f8f9fa; border-radius: 6px; border: 1px solid #e0e0e0;">
                        <div style="font-weight: 600; margin-bottom: 6px;">${escapeHtml(c.name)} ${getConfidenceBadge(c.confidence)}</div>
                        <div style="font-size: 13px; color: #666;">
                          ${c.email ? `<div>‚úâ ${escapeHtml(c.email)}</div>` : ''}
                          ${c.organization ? `<div>üè¢ ${escapeHtml(c.organization)}</div>` : ''}
                          ${c.title ? `<div>üíº ${escapeHtml(c.title)}</div>` : ''}
                          ${c.phone ? `<div>üìû ${escapeHtml(c.phone)}</div>` : ''}
                        </div>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}

              ${parsed.action_items && parsed.action_items.length > 0 ? `
                <div style="margin-bottom: 24px;">
                  <h3 style="margin: 0 0 12px 0; font-size: 16px;">Action Items (${parsed.action_items.length})</h3>
                  ${parsed.action_items.map(a => `
                    <div style="padding: 12px; background: #e8f4fd; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #0066cc;">
                      <div style="font-weight: 600;">${escapeHtml(a.item)}</div>
                      <div style="font-size: 13px; color: #666; margin-top: 4px;">
                        ${a.owner ? `Owner: ${escapeHtml(a.owner)} | ` : ''}
                        ${a.deadline ? `Deadline: ${escapeHtml(a.deadline)} | ` : ''}
                        Priority: ${a.priority || 'normal'} ${getConfidenceBadge(a.confidence)}
                      </div>
                    </div>
                  `).join('')}
                </div>
              ` : ''}

              ${parsed.fundraising && parsed.fundraising.signals && parsed.fundraising.signals.length > 0 ? `
                <div style="margin-bottom: 24px;">
                  <h3 style="margin: 0 0 12px 0; font-size: 16px;">üéØ Fundraising Signals</h3>
                  <ul style="margin: 0; padding-left: 20px;">
                    ${parsed.fundraising.signals.map(s => `<li>${escapeHtml(s)}</li>`).join('')}
                  </ul>
                </div>
              ` : ''}

              ${parsed.flags && parsed.flags.length > 0 ? `
                <div style="margin-bottom: 24px;">
                  <h3 style="margin: 0 0 12px 0; font-size: 16px;">‚ö†Ô∏è Flags</h3>
                  ${parsed.flags.map(f => `
                    <div style="padding: 8px 12px; background: #fff3cd; border-radius: 4px; margin-bottom: 6px; border-left: 3px solid #ffc107; font-size: 14px;">
                      ${escapeHtml(f)}
                    </div>
                  `).join('')}
                </div>
              ` : ''}

              ${parsed.recommended_next_steps && parsed.recommended_next_steps.length > 0 ? `
                <div style="margin-bottom: 24px;">
                  <h3 style="margin: 0 0 12px 0; font-size: 16px;">üìã Recommended Next Steps</h3>
                  <ol style="margin: 0; padding-left: 20px;">
                    ${parsed.recommended_next_steps.map(s => `<li style="margin-bottom: 6px;">${escapeHtml(s)}</li>`).join('')}
                  </ol>
                </div>
              ` : ''}

              <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid #e0e0e0; display: flex; gap: 12px;">
                <button onclick="approveEmail('${email.id}')" class="admin-btn admin-btn-success admin-btn-sm">
                  ‚úì Approve
                </button>
                <button onclick="rejectEmail('${email.id}')" class="admin-btn admin-btn-danger admin-btn-sm">
                  ‚úó Reject
                </button>
                <button onclick="closeEmailModal()" class="admin-btn admin-btn-secondary admin-btn-sm" style="margin-left: auto;">
                  Close
                </button>
              </div>
            </div>
          </div>
        </div>
      `;

      const modalDiv = document.createElement('div');
      modalDiv.id = 'emailModal';
      modalDiv.innerHTML = modalHtml;
      document.body.appendChild(modalDiv);
    }

    function closeEmailModal(event) {
      if (event && event.target !== event.currentTarget) return;
      const modal = document.getElementById('emailModal');
      if (modal) {
        modal.remove();
      }
    }

    async function approveEmail(id) {
      try {
        const token = localStorage.getItem('isrs_session_token');
        const response = await fetch(`${API_BASE}/api/email-parsing/${id}/approve`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          closeEmailModal();
          loadParsedEmails();
        } else {
          alert('Failed to approve email');
        }
      } catch (error) {
        console.error('Error approving email:', error);
        alert('Error approving email');
      }
    }

    async function rejectEmail(id) {
      try {
        const token = localStorage.getItem('isrs_session_token');
        const response = await fetch(`${API_BASE}/api/email-parsing/${id}/reject`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          closeEmailModal();
          loadParsedEmails();
        } else {
          alert('Failed to reject email');
        }
      } catch (error) {
        console.error('Error rejecting email:', error);
        alert('Error rejecting email');
      }
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>

  <!-- Feedback Widget -->
  <script src="/js/feedback-widget.js"></script>
  <script>
    initFeedbackWidget({ isAdminPortal: true });
  </script>
</body>
</html>
