<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Email Parser - ISRS Admin</title>
  <link rel="icon" type="image/png" href="/images/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Marcellus&family=PT+Serif:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="/css/admin-layout.css">
  <link rel="stylesheet" href="/css/admin-unified.css">
  <script src="/js/errorReporter.js"></script>
  <style>
    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--admin-space-xl);
    }
    @media (max-width: 1024px) {
      .two-column {
        grid-template-columns: 1fr;
      }
    }
    .parse-form textarea {
      min-height: 250px;
      font-family: monospace;
      font-size: var(--admin-text-sm);
    }
    .confidence-badge {
      display: inline-block;
      padding: 0.125rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.7rem;
      font-weight: 600;
    }
    .confidence-high {
      background: var(--admin-success-bg);
      color: var(--admin-success-text);
    }
    .confidence-medium {
      background: var(--admin-warning-bg);
      color: var(--admin-warning-text);
    }
    .confidence-low {
      background: var(--admin-danger-bg);
      color: var(--admin-danger-text);
    }
    .contact-card {
      background: var(--admin-gray-50);
      padding: var(--admin-space-md);
      border-radius: var(--admin-radius-md);
      margin-bottom: var(--admin-space-sm);
    }
    .contact-card h4 {
      margin: 0 0 var(--admin-space-xs) 0;
      font-size: var(--admin-text-md);
    }
    .contact-info {
      font-size: var(--admin-text-sm);
      color: var(--admin-gray-600);
    }
    .action-item {
      background: var(--admin-info-bg);
      border-left: 3px solid var(--admin-info);
      padding: var(--admin-space-md);
      margin-bottom: var(--admin-space-sm);
      border-radius: var(--admin-radius-sm);
    }
    .flag-item {
      background: var(--admin-danger-bg);
      border-left: 3px solid var(--admin-danger);
      padding: var(--admin-space-sm) var(--admin-space-md);
      margin-bottom: var(--admin-space-sm);
      border-radius: var(--admin-radius-sm);
      font-size: var(--admin-text-sm);
    }
    .email-item {
      background: var(--admin-gray-50);
      padding: var(--admin-space-md);
      border-radius: var(--admin-radius-md);
      margin-bottom: var(--admin-space-md);
      cursor: pointer;
      transition: all 0.15s;
      border: 1px solid var(--admin-gray-200);
    }
    .email-item:hover {
      background: var(--admin-surface-hover);
      transform: translateY(-2px);
      box-shadow: var(--admin-shadow-sm);
    }
    .email-subject {
      font-weight: 600;
      color: var(--admin-text);
      margin-bottom: var(--admin-space-xs);
    }
    .email-from {
      font-size: var(--admin-text-sm);
      color: var(--admin-gray-600);
    }
    .review-status {
      display: inline-block;
      padding: 0.125rem 0.5rem;
      border-radius: var(--admin-radius-sm);
      font-size: 0.7rem;
      font-weight: 600;
      margin-top: var(--admin-space-sm);
    }
    .status-approved {
      background: var(--admin-success-bg);
      color: var(--admin-success-text);
    }
    .status-pending {
      background: var(--admin-warning-bg);
      color: var(--admin-warning-text);
    }
    .result-section {
      margin-top: var(--admin-space-lg);
      padding-top: var(--admin-space-lg);
      border-top: 1px solid var(--admin-gray-200);
    }
    .result-section:first-child {
      margin-top: 0;
      padding-top: 0;
      border-top: none;
    }
    .result-section h3 {
      margin: 0 0 var(--admin-space-md) 0;
      font-size: var(--admin-text-md);
    }
    .parsed-emails-list {
      max-height: 500px;
      overflow-y: auto;
    }
    .empty-state {
      text-align: center;
      padding: var(--admin-space-2xl);
      color: var(--admin-gray-500);
    }
    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: var(--admin-space-md);
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--admin-gray-200);
      border-top-color: var(--admin-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto var(--admin-space-md);
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="admin-page">
  <div class="admin-content-padded" style="max-width: 1400px; margin: 0 auto;">
    <!-- Page Header -->
    <div class="admin-page-header" style="background: transparent; border: none; padding-left: 0;">
      <h1>Email Parser</h1>
      <p class="admin-text-muted">Automatically extract contacts, action items, and fundraising signals from emails</p>
    </div>

    <div class="two-column">
      <!-- Left: Parse New Email -->
      <div>
        <div class="admin-card">
          <div class="admin-card-header">
            <h2 style="margin: 0;">Parse New Email</h2>
          </div>
          <div class="admin-card-body">
            <form id="parseForm" class="parse-form" onsubmit="parseEmail(event)">
              <div class="admin-form-group">
                <label class="admin-label">Subject</label>
                <input type="text" id="subject" class="admin-input" placeholder="Email subject line" required>
              </div>
              <div class="admin-form-group">
                <label class="admin-label">From Name</label>
                <input type="text" id="fromName" class="admin-input" placeholder="Sender name">
              </div>
              <div class="admin-form-group">
                <label class="admin-label">From Email</label>
                <input type="email" id="fromEmail" class="admin-input" placeholder="sender@example.com" required>
              </div>
              <div class="admin-form-group">
                <label class="admin-label">Email Body</label>
                <textarea id="emailBody" class="admin-input" placeholder="Paste full email content here..." required></textarea>
              </div>
              <button type="submit" class="admin-btn admin-btn-primary" id="parseBtn" style="width: 100%;">
                Parse Email
              </button>
            </form>
          </div>
        </div>

        <!-- Results -->
        <div id="results" class="admin-card" style="display: none; margin-top: var(--admin-space-lg);">
          <div class="admin-card-header">
            <h2 style="margin: 0;">Parsed Results</h2>
          </div>
          <div class="admin-card-body" id="resultsContent">
            <!-- Populated dynamically -->
          </div>
        </div>
      </div>

      <!-- Right: Recent Parsed Emails -->
      <div>
        <div class="admin-card">
          <div class="admin-card-header">
            <h2 style="margin: 0;">Recently Parsed Emails</h2>
            <button class="admin-btn admin-btn-secondary admin-btn-sm" onclick="loadParsedEmails()">
              <span style="margin-right: 0.25rem;">â†»</span> Refresh
            </button>
          </div>
          <div class="admin-card-body" style="padding: 0;">
            <div id="loading" class="empty-state">
              <div class="loading-spinner"></div>
              <p>Loading parsed emails...</p>
            </div>
            <div id="parsedEmailsList" class="parsed-emails-list" style="display: none; padding: var(--admin-space-lg);"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/email-utils.js"></script>
  <script src="/js/admin-layout.js"></script>
  <script>
    const API_BASE = '';  // Use same-origin

    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      const sessionToken = localStorage.getItem('isrs_session_token');
      if (!sessionToken) {
        window.location.href = '/admin/';
        return;
      }

      loadAdminLayout('email-parser');
      loadParsedEmails();
    });

    async function parseEmail(event) {
      event.preventDefault();

      const subject = document.getElementById('subject').value;
      const fromName = document.getElementById('fromName').value;
      const fromEmail = document.getElementById('fromEmail').value;
      const emailBody = document.getElementById('emailBody').value;

      const btn = document.getElementById('parseBtn');
      btn.disabled = true;
      btn.textContent = 'Parsing...';
      document.getElementById('results').style.display = 'none';

      try {
        const token = localStorage.getItem('isrs_session_token');
        const response = await fetch(`${API_BASE}/api/email-parsing/parse`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            subject,
            fromName,
            fromEmail,
            emailBody,
            receivedDate: new Date().toISOString()
          })
        });

        if (!response.ok) {
          if (response.status === 404) {
            throw new Error('Email parsing API not available. This feature requires backend configuration.');
          }
          throw new Error('Failed to parse email');
        }

        const data = await response.json();

        if (data.success) {
          displayResults(data);
          loadParsedEmails();
          document.getElementById('parseForm').reset();
        } else {
          alert('Error: ' + (data.error || 'Failed to parse email'));
        }
      } catch (error) {
        console.error('Parse error:', error);
        alert(error.message || 'Failed to parse email. Please try again.');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Parse Email';
      }
    }

    function displayResults(data) {
      const { parsed, overallConfidence } = data;

      let html = `
        <div class="result-section">
          <div style="margin-bottom: var(--admin-space-md);">
            <strong>Overall Confidence:</strong> ${getConfidenceBadge(overallConfidence)}
            <span style="margin-left: var(--admin-space-md); color: var(--admin-gray-600);">
              Review Status: ${data.reviewStatus || 'pending'}
            </span>
          </div>
        </div>
      `;

      if (parsed.summary) {
        html += `
          <div class="result-section">
            <h3>Summary</h3>
            <p style="margin: 0; color: var(--admin-gray-700);">${escapeHtml(parsed.summary)}</p>
          </div>
        `;
      }

      if (parsed.contacts && parsed.contacts.length > 0) {
        html += `
          <div class="result-section">
            <h3>Contacts Extracted (${parsed.contacts.length})</h3>
            ${parsed.contacts.map(c => `
              <div class="contact-card">
                <h4>${escapeHtml(c.name)} ${getConfidenceBadge(c.confidence)}</h4>
                <div class="contact-info">
                  ${c.email ? `<div>Email: ${escapeHtml(c.email)}</div>` : ''}
                  ${c.organization ? `<div>Organization: ${escapeHtml(c.organization)}</div>` : ''}
                  ${c.title ? `<div>Title: ${escapeHtml(c.title)}</div>` : ''}
                  ${c.phone ? `<div>Phone: ${escapeHtml(c.phone)}</div>` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        `;
      }

      if (parsed.action_items && parsed.action_items.length > 0) {
        html += `
          <div class="result-section">
            <h3>Action Items (${parsed.action_items.length})</h3>
            ${parsed.action_items.map(a => `
              <div class="action-item">
                <strong>${escapeHtml(a.item)}</strong>
                <div style="font-size: var(--admin-text-sm); margin-top: var(--admin-space-xs); color: var(--admin-gray-600);">
                  ${a.owner ? `Owner: ${escapeHtml(a.owner)} | ` : ''}
                  ${a.deadline ? `Deadline: ${escapeHtml(a.deadline)} | ` : ''}
                  Priority: ${a.priority || 'normal'} ${getConfidenceBadge(a.confidence)}
                </div>
              </div>
            `).join('')}
          </div>
        `;
      }

      if (parsed.fundraising && parsed.fundraising.signals && parsed.fundraising.signals.length > 0) {
        html += `
          <div class="result-section">
            <h3>Fundraising Signals</h3>
            <ul style="margin: 0; padding-left: var(--admin-space-lg);">
              ${parsed.fundraising.signals.map(s => `<li>${escapeHtml(s)}</li>`).join('')}
            </ul>
          </div>
        `;
      }

      if (parsed.flags && parsed.flags.length > 0) {
        html += `
          <div class="result-section">
            <h3>Flags</h3>
            ${parsed.flags.map(f => `<div class="flag-item">${escapeHtml(f)}</div>`).join('')}
          </div>
        `;
      }

      if (parsed.recommended_next_steps && parsed.recommended_next_steps.length > 0) {
        html += `
          <div class="result-section">
            <h3>Recommended Next Steps</h3>
            <ol style="margin: 0; padding-left: var(--admin-space-lg);">
              ${parsed.recommended_next_steps.map(s => `<li>${escapeHtml(s)}</li>`).join('')}
            </ol>
          </div>
        `;
      }

      document.getElementById('resultsContent').innerHTML = html;
      document.getElementById('results').style.display = 'block';
    }

    function getConfidenceBadge(confidence) {
      if (!confidence && confidence !== 0) return '';
      const level = confidence >= 70 ? 'high' : confidence >= 50 ? 'medium' : 'low';
      return `<span class="confidence-badge confidence-${level}">${confidence}%</span>`;
    }

    async function loadParsedEmails() {
      const loadingEl = document.getElementById('loading');
      const listEl = document.getElementById('parsedEmailsList');

      loadingEl.style.display = 'block';
      listEl.style.display = 'none';

      try {
        const token = localStorage.getItem('isrs_session_token');
        const response = await fetch(`${API_BASE}/api/email-parsing`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          if (response.status === 404) {
            displayParsedEmails([]);
            return;
          }
          throw new Error('Failed to load emails');
        }

        const data = await response.json();

        if (data.success) {
          displayParsedEmails(data.emails || []);
        } else {
          displayParsedEmails([]);
        }
      } catch (error) {
        console.error('Load error:', error);
        displayParsedEmails([]);
      }
    }

    function displayParsedEmails(emails) {
      const loadingEl = document.getElementById('loading');
      const listEl = document.getElementById('parsedEmailsList');

      loadingEl.style.display = 'none';
      listEl.style.display = 'block';

      if (!emails || emails.length === 0) {
        listEl.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ðŸ“§</div>
            <h3 style="margin: 0 0 var(--admin-space-sm) 0;">No Parsed Emails Yet</h3>
            <p style="margin: 0;">Parse an email using the form to see results here.</p>
          </div>
        `;
        return;
      }

      listEl.innerHTML = emails.map(email => `
        <div class="email-item" onclick="viewEmail('${email.id}')">
          <div class="email-subject">${escapeHtml(email.subject || '(No subject)')}</div>
          <div class="email-from">From: ${escapeHtml(email.from_name || email.from_email || 'Unknown')}</div>
          <div>
            <span class="review-status status-${email.review_status || 'pending'}">
              ${email.review_status || 'pending'}
            </span>
            ${email.overall_confidence ? `<span class="confidence-badge confidence-${email.overall_confidence >= 70 ? 'high' : email.overall_confidence >= 50 ? 'medium' : 'low'}" style="margin-left: var(--admin-space-sm);">${email.overall_confidence}%</span>` : ''}
          </div>
        </div>
      `).join('');
    }

    function viewEmail(id) {
      // TODO: Implement full email details view
      alert(`Email details view coming soon!\n\nEmail ID: ${id}`);
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>

  <!-- Feedback Widget -->
  <script src="/js/feedback-widget.js"></script>
  <script>
    initFeedbackWidget({ isAdminPortal: true });
  </script>
</body>
</html>
