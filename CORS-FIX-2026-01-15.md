# CORS Fix - January 15, 2026

**Status:** ğŸ”„ Deploying
**Time:** 2026-01-15 13:40 EST
**Issue:** Frontend blocked by CORS policy

---

## ğŸš¨ Original Error

```
Access to fetch at 'https://isrs-database-backend.onrender.com/api/auth/request-login'
from origin 'https://www.shellfish-society.org' has been blocked by CORS policy:
Response to preflight request doesn't pass access control check:
No 'Access-Control-Allow-Origin' header is present on the requested resource.
```

**Symptoms:**
- âœ— Login requests failing from www.shellfish-society.org
- âœ— API calls blocked by browser
- âœ— Frontend calling wrong backend URL

---

## ğŸ” Root Causes Found

### Issue #1: Wrong Backend URL in Frontend

**Problem:**
- Frontend hardcoded to call: `https://isrs-database-backend.onrender.com`
- Actual backend is at: `https://isrs-python-backend.onrender.com`
- Old service (`isrs-database-backend`) no longer exists

**Files Affected:** 47 files
- HTML: admin pages, conference pages, member pages, auth pages
- JavaScript: api.js, api-config.js, member-auth.js, photo-uploader.js, etc.

### Issue #2: Missing CORS Origin

**Problem:**
- CORS allowed: `localhost:3000`, `localhost:5173`, `isrs-database-frontend.onrender.com`
- CORS missing: `www.shellfish-society.org`, `shellfish-society.org`
- Frontend hosted at www.shellfish-society.org couldn't access API

---

## âœ… Fixes Applied

### 1. Updated All Frontend Files

**Changed FROM:**
```javascript
const API_BASE_URL = 'https://isrs-database-backend.onrender.com';
```

**Changed TO:**
```javascript
const API_BASE_URL = 'https://isrs-python-backend.onrender.com';
```

**Method:**
```bash
find frontend/public -type f \( -name "*.html" -o -name "*.js" \) \
  -exec sed -i '' 's/https:\/\/isrs-database-backend\.onrender\.com/https:\/\/isrs-python-backend.onrender.com/g' {} \;
```

**Files Updated:** 47 files across frontend/public

### 2. Updated CORS Configuration

**File:** `backend-python/render.yaml`

**Changed FROM:**
```yaml
- key: CORS_ORIGINS
  value: http://localhost:3000,http://localhost:5173,https://isrs-database-frontend.onrender.com
```

**Changed TO:**
```yaml
- key: CORS_ORIGINS
  value: http://localhost:3000,http://localhost:5173,https://isrs-database-frontend.onrender.com,https://www.shellfish-society.org,https://shellfish-society.org
```

**Added:**
- âœ… `https://www.shellfish-society.org`
- âœ… `https://shellfish-society.org` (non-www variant)

---

## ğŸ“‚ Changed Files Summary

| Category | Files Changed |
|----------|--------------|
| **Admin Pages** | 16 files |
| **Conference Pages** | 3 files |
| **Member/Profile Pages** | 8 files |
| **Auth Pages** | 2 files |
| **JavaScript API Files** | 8 files |
| **Other Pages** | 10 files |
| **Backend Config** | 1 file (render.yaml) |
| **Total** | **48 files** |

---

## ğŸ”„ Deployment Timeline

| Time | Event | Commit |
|------|-------|--------|
| 13:33 | Rolled back security updates | a58674e |
| 13:40 | Fixed CORS + frontend URLs | 528170a |
| 13:42 | Deployment triggered | (in progress) |
| ~13:45 | Expected completion | ETA 3 min |

---

## ğŸ§ª Testing Checklist

Once deployment completes, test:

### 1. Backend API Endpoints
- [ ] `https://isrs-python-backend.onrender.com/health`
- [ ] `https://isrs-python-backend.onrender.com/api/auth/request-login`
- [ ] `https://isrs-python-backend.onrender.com/docs`

### 2. Frontend Login Flow
- [ ] Go to `https://www.shellfish-society.org`
- [ ] Click "Login" or "Member Portal"
- [ ] Enter email address
- [ ] Submit login form
- [ ] Check browser console for CORS errors (should be none!)
- [ ] Verify API call succeeds

### 3. CORS Headers
Test with curl:
```bash
curl -i -X OPTIONS \
  -H "Origin: https://www.shellfish-society.org" \
  -H "Access-Control-Request-Method: POST" \
  -H "Access-Control-Request-Headers: Content-Type" \
  https://isrs-python-backend.onrender.com/api/auth/request-login
```

**Expected Response:**
```
Access-Control-Allow-Origin: https://www.shellfish-society.org
Access-Control-Allow-Methods: POST, GET, OPTIONS, ...
Access-Control-Allow-Headers: Content-Type, ...
```

---

## ğŸ“Š Architecture Overview

### Current Setup

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  www.shellfish-society.org       â”‚
â”‚  (Static Frontend)               â”‚
â”‚  - Conference registration       â”‚
â”‚  - Member portal                 â”‚
â”‚  - Admin dashboard               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ API Calls (âœ… CORS allowed)
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  isrs-python-backend.onrender.comâ”‚
â”‚  (FastAPI Backend)               â”‚
â”‚  - /api/auth/*                   â”‚
â”‚  - /api/contacts/*               â”‚
â”‚  - /api/conferences/*            â”‚
â”‚  - /health                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### What Happens Now

1. User visits `https://www.shellfish-society.org`
2. Frontend loads (HTML/CSS/JS)
3. User clicks "Login"
4. JavaScript makes API call to `https://isrs-python-backend.onrender.com/api/auth/request-login`
5. Browser sends preflight OPTIONS request
6. Backend responds with CORS headers including `Access-Control-Allow-Origin: https://www.shellfish-society.org`
7. Browser allows the actual POST request
8. Login succeeds âœ…

---

## ğŸ”§ Configuration Details

### Backend CORS Setup

**File:** `backend-python/app/main.py`

```python
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.CORS_ORIGINS,  # From render.yaml
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

**Environment Variable:** `CORS_ORIGINS`

**Value (after fix):**
```
http://localhost:3000,
http://localhost:5173,
https://isrs-database-frontend.onrender.com,
https://www.shellfish-society.org,
https://shellfish-society.org
```

---

## ğŸ“ Related Documentation

- **Security Updates (Failed):** `SECURITY-UPDATES-2026-01-15.md`
- **Rollback Details:** `ROLLBACK-AND-RENDER-API-2026-01-15.md`
- **Render Service IDs:** `_SYSTEM/RENDER-SERVICE-IDS.md`
- **Render Status Checker:** `_SYSTEM/render-status-check.sh`

---

## ğŸ¯ Next Steps

### Immediate (After Deployment)
1. â³ Wait for deployment to complete (~3 minutes)
2. âœ… Test www.shellfish-society.org login flow
3. âœ… Verify CORS headers in browser DevTools
4. âœ… Confirm no console errors

### Short-Term
1. Update frontend to use environment variables for API URL
2. Create frontend build process with config injection
3. Add automated CORS testing to CI/CD

### Medium-Term
1. Consolidate frontend hosting (currently separate from backend)
2. Consider single-domain architecture
3. Implement API gateway for better CORS management

---

## ğŸ”’ Security Considerations

**CORS Origins:**
- âœ… Specific domains listed (not wildcards)
- âœ… HTTPS enforced in production
- âœ… Localhost allowed for local development
- âœ… No overly permissive `allow_origins=["*"]`

**What's Safe:**
- Production frontend can call production backend
- Local development frontend can call local backend
- Credentials (cookies) allowed via `allow_credentials=True`

**What's Blocked:**
- Any domain not explicitly listed
- HTTP requests to HTTPS backend (mixed content)
- Unauthorized cross-origin requests

---

## âœ… Summary

**What Was Broken:**
- Frontend calling wrong backend URL
- CORS policy blocking www.shellfish-society.org
- 47 files with outdated API configuration

**What We Fixed:**
- âœ… Updated all 47 frontend files to new backend URL
- âœ… Added www.shellfish-society.org to CORS whitelist
- âœ… Added shellfish-society.org (non-www) to CORS whitelist
- âœ… Committed and pushed changes
- âœ… Triggered automatic deployment

**Status:**
- ğŸ”„ Deployment in progress
- â±ï¸ ETA: ~3 minutes
- ğŸ¯ Next: Test login flow after deployment

---

**Created:** 2026-01-15 13:42 EST
**Commit:** 528170a
**Deployment:** In Progress
**ETA:** 13:45 EST
